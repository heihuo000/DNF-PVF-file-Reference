# MAP文件依赖关系简介

> 🔗 MAP文件与其他游戏文件的依赖关系速查手册

## 📋 目录

- [核心依赖文件](#核心依赖文件)
- [资源文件依赖](#资源文件依赖)
- [脚本文件依赖](#脚本文件依赖)
- [配置文件依赖](#配置文件依赖)
- [依赖关系图](#依赖关系图)
- [常见依赖问题](#常见依赖问题)

---

## 核心依赖文件

### 🎨 图像资源文件
**文件类型**: `.img` 文件
**依赖关系**: MAP → IMG
**用途**: 提供地图的视觉元素

```map
[tile info]
	`tile image`	`tile/town_basic.img`	// 瓦片图像
	
[passive object]
	`obj 0`	`character/npc_seria.img`	// NPC图像
```

**依赖说明**:
- MAP文件通过路径引用IMG文件
- IMG文件必须存在于指定路径
- 路径相对于PVF根目录

### 🔧 属性配置文件
**文件类型**: `.til`, `.ani`, `.snd` 等
**依赖关系**: MAP → 配置文件
**用途**: 定义瓦片属性、动画、音效等

```map
[tile info]
	`tile attribute`	`tile/town_basic.til`	// 瓦片属性

[animation]
	`ani filename`		`effect/fire.ani`	// 动画配置

[sound]
	`sound filename`	`sound/town_bgm.snd`	// 音效配置
```

---

## 资源文件依赖

### 🎵 音频文件
**文件类型**: `.ogg`, `.wav`
**依赖路径**: `Music/`, `Sound/`

```map
[map attribute]
	`bgm`	`Music/town_peaceful.ogg`	// 背景音乐

[sound]
	`sound 0`	`Sound/footstep.wav`	// 音效文件
```

**注意事项**:
- 音频文件格式必须为OGG或WAV
- 路径区分大小写
- 文件大小影响加载性能

### 🖼️ 纹理文件
**文件类型**: `.img`, `.npk`
**依赖路径**: `sprite/`, `tile/`, `character/`

```map
[tile info]
	`tile image`	`sprite/map/town_floor.img`

[passive object]
	`obj 0`	`character/npc/seria.img`
```

---

## 脚本文件依赖

### 📜 NUT脚本
**文件类型**: `.nut`
**依赖关系**: MAP → NUT (间接)
**用途**: 地图逻辑、NPC行为、事件处理

```map
[passive object]
	`obj 0`	`character/npc_seria.img`
	// 对应脚本: sqr/npc/seria.nut
```

**脚本关联**:
- NPC对象 → `sqr/npc/` 目录下的对应脚本
- 地图事件 → `sqr/map/` 目录下的地图脚本
- 特殊功能 → `sqr/passiveobject/` 目录下的对象脚本

### 🎯 事件脚本
**触发条件**: 地图加载、玩家交互、条件满足

```map
[monster]
	`monster 0`	`monster/goblin.chr`
	// 对应脚本: sqr/monster/goblin.nut

[passive object]
	`obj 0`	`passiveobject/treasure_box.img`
	// 对应脚本: sqr/passiveobject/treasure_box.nut
```

---

## 配置文件依赖

### ⚙️ 系统配置
**文件类型**: `.cfg`, `.ini`
**依赖关系**: MAP → 系统配置

```map
[map attribute]
	`camera limit rect`	0	0	800	600	// 依赖相机系统配置
	`skill no effect`	1		// 依赖技能系统配置
```

### 📊 数据文件
**文件类型**: `.lst`, `.stk`, `.equ`
**依赖关系**: MAP → 数据文件 (间接)

```map
[monster]
	`monster 0`	`monster/goblin.chr`
	// 间接依赖: equipment.lst, stackable.lst 等
```

---

## 依赖关系图

```
MAP文件
├── 直接依赖
│   ├── IMG文件 (图像资源)
│   ├── TIL文件 (瓦片属性)
│   ├── ANI文件 (动画配置)
│   ├── SND文件 (音效配置)
│   └── OGG/WAV文件 (音频资源)
│
├── 间接依赖
│   ├── NUT脚本 (逻辑处理)
│   ├── CHR文件 (角色数据)
│   ├── LST文件 (列表数据)
│   └── CFG文件 (系统配置)
│
└── 运行时依赖
    ├── 内存资源
    ├── 系统服务
    └── 网络连接
```

---

## 常见依赖问题

### ❌ 文件缺失
**现象**: 地图加载失败、资源显示异常
**原因**: 引用的文件不存在
**解决**:
```map
// 检查文件路径是否正确
[tile info]
	`tile image`	`tile/town_basic.img`	// 确保文件存在
```

### ❌ 路径错误
**现象**: 资源无法加载
**原因**: 文件路径不正确
**解决**:
- 使用相对路径（相对于PVF根目录）
- 检查路径分隔符（使用 `/`）
- 确认大小写匹配

### ❌ 格式不兼容
**现象**: 文件加载但显示异常
**原因**: 文件格式版本不匹配
**解决**:
- 确保所有文件版本一致
- 使用标准的DNF文件格式
- 检查文件编码格式

### ❌ 循环依赖
**现象**: 加载卡死或崩溃
**原因**: 文件间存在循环引用
**解决**:
- 梳理依赖关系
- 避免相互引用
- 使用单向依赖设计

---

## 🔍 依赖检查工具

### 手动检查清单
- [ ] 所有IMG文件路径正确
- [ ] 音频文件格式符合要求
- [ ] 脚本文件存在且无语法错误
- [ ] 配置文件参数有效
- [ ] 无循环依赖关系

### 自动化检查
```bash
# 使用PVF格式检查工具
python PVF格式检查工具.py --check-dependencies map_file.map
```

---

## 📚 相关文档

- [标签参考.md](标签参考.md) - 了解各标签的依赖要求
- [常见问题.md](常见问题.md) - 依赖相关的错误解决
- [PVF文件格式规范](../PVF文件格式规范.md) - 文件格式标准
- [模板文件/](模板文件/) - 标准依赖配置示例

---
*最后更新: 2024年*