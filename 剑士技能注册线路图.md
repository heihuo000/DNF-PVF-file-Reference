# 剑士技能注册完整线路图

## 概述
本文档详细描述了DNF中剑士职业技能的完整注册流程和文件结构。

## 搜索参数重要发现
在使用`mcp_PvfTool_search_pvf`工具时，`search_type`参数的正确使用：
- `search_type=0`: 返回null（无结果）
- `search_type=1`: 返回空数组（无结果）  
- `search_type=2`: **正确返回搜索结果** ✅

## 技能注册流程图

```
游戏启动
    ↓
sqr/loadstate.nut (主加载文件)
    ↓
sq_RunScript("Character/swordman_load_state.nut")
    ↓
sqr/character/swordman_load_state.nut (剑士专用加载文件)
    ↓
┌─────────────────────────────────────────────────────────────┐
│                    剑士技能注册流程                          │
├─────────────────────────────────────────────────────────────┤
│ 1. 被动对象注册 (pushPassiveObj)                            │
│ 2. 核心脚本文件加载 (pushScriptFiles)                       │
│ 3. 自定义脚本运行 (sq_RunScript)                            │
│ 4. 技能状态注册 (pushState)                                 │
└─────────────────────────────────────────────────────────────┘
```

## 详细文件结构

### 1. 主加载入口
**文件**: `sqr/loadstate.nut`
```nut
sq_RunScript("Character/swordman_load_state.nut");
```

### 2. 剑士专用加载文件
**文件**: `sqr/character/swordman_load_state.nut`

#### 2.1 被动对象注册
```nut
IRDSQRCharacter.pushPassiveObj("js60_qq506807329/share_obj/share_po_swordman_24370.nut", 24370);
IRDSQRCharacter.pushPassiveObj("baynk/po_swordman_baynk.nut", 24399); // 拔刀斩相关
IRDSQRCharacter.pushPassiveObj("character/Swordman/wave/po_wavecut.nut", 24328); // 波动剑
IRDSQRCharacter.pushPassiveObj("unclebang_shared_passive_object/po_swordman_shared.nut", 24349);
IRDSQRCharacter.pushPassiveObj("character/JG_SwordMan/swordghost15/po_swordghost15.nut", 26315);
```

#### 2.2 核心脚本文件加载
```nut
IRDSQRCharacter.pushScriptFiles("character/swordman/passive_skill_swordman.nut");
IRDSQRCharacter.pushScriptFiles("character/swordman/swordman_header.nut");
IRDSQRCharacter.pushScriptFiles("character/swordman/swordman_common.nut");
IRDSQRCharacter.pushScriptFiles("Character/JG_SwordMan/jg_swordman_common.nut");
IRDSQRCharacter.pushScriptFiles("Character/JG_SwordMan/get_obj_attack.nut");
```

#### 2.3 自定义脚本运行
```nut
sq_RunScript("js60_qq506807329/share_obj/swordman/setcustomdata.nut");
sq_RunScript("js60_qq506807329/share_obj/swordman/setstate.nut");
sq_RunScript("js60_qq506807329/share_obj/swordman/procappend.nut");
sq_RunScript("js60_qq506807329/share_obj/swordman/onendcurrentani.nut");
sq_RunScript("js60_qq506807329/share_obj/swordman/else.nut");
```

#### 2.4 技能状态注册 (部分示例)
```nut
// 基础技能
IRDSQRCharacter.pushState(ENUM_CHARACTERJOB_SWORDMAN, "character/swordman/attack/attack.nut", "swordman_attack", 8, -1);
IRDSQRCharacter.pushState(ENUM_CHARACTERJOB_SWORDMAN, "character/swordman/BackStep/BackStep.nut", "swordman_backstep", 7, -1);

// 血剑系列
IRDSQRCharacter.pushState(ENUM_CHARACTERJOB_SWORDMAN, "character/swordman/bloodboom/bloodboom.nut", "swordman_bloodboom", 229, 229);
IRDSQRCharacter.pushState(ENUM_CHARACTERJOB_SWORDMAN, "character/swordman/bloodmarble/bloodmarble.nut", "swordman_bloodmarble", 230, 230);

// 剑魂技能
IRDSQRCharacter.pushState(ENUM_CHARACTERJOB_SWORDMAN, "Character/JG_SwordMan/SwordGhost1/SwordGhost1.nut", "SwordGhost1", STATE_SWORD_GHOST_1, SKILL_SWORD_GHOST_1);
// ... 更多剑魂技能
```

## 被动对象文件详解

### 1. js60_qq506807329 系列
- **文件**: `sqr/js60_qq506807329/share_obj/share_po_swordman_24370.nut`
- **ID**: 24370
- **内容**: 空文件（可能用于占位或特殊用途）

### 2. 拔刀斩被动对象
- **文件**: `sqr/baynk/po_swordman_baynk.nut`
- **ID**: 24399
- **功能**: 拔刀斩技能相关
- **加载脚本**:
  ```nut
  sq_RunScript("baynk/swordman/setcustomdata.nut");
  sq_RunScript("baynk/swordman/setstate.nut");
  sq_RunScript("baynk/swordman/onendcurrentani.nut");
  sq_RunScript("baynk/swordman/onkeyframeflag.nut");
  sq_RunScript("baynk/swordman/procappend.nut");
  sq_RunScript("baynk/swordman/onattack.nut");
  sq_RunScript("baynk/swordman/ontimeevent.nut");
  ```

### 3. 波动剑被动对象
- **文件**: `sqr/character/Swordman/wave/po_wavecut.nut`
- **ID**: 24328
- **功能**: 波动剑技能相关

## 核心脚本文件说明

| 文件名 | 功能描述 |
|--------|----------|
| `swordman_header.nut` | 剑士头文件，包含常量和基础定义 |
| `swordman_common.nut` | 剑士通用函数库 |
| `passive_skill_swordman.nut` | 剑士被动技能处理 |
| `jg_swordman_common.nut` | 剑魂专用通用函数 |
| `get_obj_attack.nut` | 对象攻击获取函数 |

## 自定义脚本功能

| 脚本名 | 功能描述 |
|--------|----------|
| `setcustomdata.nut` | 设置自定义数据 |
| `setstate.nut` | 设置技能状态 |
| `procappend.nut` | 处理技能追加效果 |
| `onendcurrentani.nut` | 动画结束时的处理 |
| `else.nut` | 其他杂项处理 |

## 技能分类

### 基础技能
- 普通攻击 (attack)
- 后跳斩 (backstep)
- 投掷 (throw)
- 跳跃 (jump)

### 血剑系列
- 血爆 (bloodboom)
- 血珠 (bloodmarble)
- 血刃 (bloodriven)
- 嗜血 (bloodsnatch)
- 致命血刃 (fatalblood)

### 剑魂技能
- 剑魂1-23号技能
- 剑魂28-29号技能
- 三段斩效果 (tripleslash)

### 武器大师技能
- 心剑 (flowmind)
- 崩山击 (grandwave)
- 里鬼剑术 (blache)

### 特殊技能
- 拔刀斩 (momentaryslash)
- 波动剑 (wave)
- 鬼斩 (sacrifice)
- 明炎剑 (mingyanjian)
- 英雄 (hero)

## 注册机制说明

### pushPassiveObj
注册被动对象，用于处理特殊效果和逻辑
```nut
IRDSQRCharacter.pushPassiveObj(文件路径, 对象ID);
```

### pushScriptFiles
加载脚本文件到角色系统
```nut
IRDSQRCharacter.pushScriptFiles(文件路径);
```

### pushState
注册技能状态
```nut
IRDSQRCharacter.pushState(职业枚举, 文件路径, 状态名, 状态ID, 技能ID);
```

### sq_RunScript
直接运行脚本文件
```nut
sq_RunScript(文件路径);
```

## 总结

剑士技能注册采用了分层加载的方式：
1. **主加载器** → **职业加载器** → **具体技能文件**
2. **被动对象** 处理特殊逻辑和效果
3. **核心脚本** 提供通用函数和基础功能
4. **自定义脚本** 处理特定的游戏逻辑
5. **技能状态** 注册具体的技能实现

这种设计使得技能系统具有良好的模块化和可扩展性。

---
*文档生成时间: 2024年*
*基于PVF文件分析结果*