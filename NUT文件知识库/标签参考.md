# NUTè„šæœ¬æ ‡ç­¾å‚è€ƒ

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### Stateï¼ˆçŠ¶æ€ï¼‰
NUTè„šæœ¬çš„æ ¸å¿ƒæ¦‚å¿µï¼Œä»£è¡¨æŠ€èƒ½æˆ–è§’è‰²çš„ä¸åŒçŠ¶æ€é˜¶æ®µã€‚

**åŠŸèƒ½ä½œç”¨**ï¼š
- å®šä¹‰æŠ€èƒ½çš„æ‰§è¡Œé˜¶æ®µå’ŒçŠ¶æ€è½¬æ¢
- æ§åˆ¶è§’è‰²è¡Œä¸ºå’ŒåŠ¨ç”»æ’­æ”¾
- ç®¡ç†æŠ€èƒ½çš„ç”Ÿå‘½å‘¨æœŸ

**ä½¿ç”¨æ–¹å¼**ï¼š
```nut
// çŠ¶æ€å®šä¹‰ç¤ºä¾‹
STATE_SKILL_NAME <- 101  // è‡ªå®šä¹‰çŠ¶æ€ç¼–å·ï¼Œé¿å…å†²çª
```

**çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ**ï¼š
- çŠ¶æ€ç¼–å·ä½¿ç”¨100ä»¥ä¸Šï¼Œé¿å…ä¸ç³»ç»ŸçŠ¶æ€å†²çª
- æ¯ä¸ªæŠ€èƒ½è‡³å°‘éœ€è¦ä¸€ä¸ªä¸»çŠ¶æ€
- å¤æ‚æŠ€èƒ½å¯ä»¥å®šä¹‰å¤šä¸ªå­çŠ¶æ€è¿›è¡Œç²¾ç»†æ§åˆ¶

## ğŸ”§ æ ¸å¿ƒå‡½æ•°è¯¦è§£

### 1. checkExecutableSkill_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šæ£€æŸ¥æŠ€èƒ½æ˜¯å¦å¯ä»¥æ‰§è¡Œçš„å‰ç½®æ¡ä»¶

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: è§’è‰²å¯¹è±¡
- è¿”å›å€¼: `true`/`false` è¡¨ç¤ºæ˜¯å¦å¯æ‰§è¡Œ

**å®é™…åº”ç”¨**ï¼š
```nut
function checkExecutableSkill_SkillName(obj)
{
    if(!obj) return false;
    
    // æ£€æŸ¥MPæ˜¯å¦è¶³å¤Ÿ
    local needMp = obj.sq_GetIntData(SKILL_SKILLNAME, SKL_MP_CONSUMPTION);
    if(obj.sq_GetMp() < needMp) return false;
    
    // æ£€æŸ¥å†·å´æ—¶é—´
    if(obj.sq_IsUseSkill(SKILL_SKILLNAME)) return false;
    
    // æ£€æŸ¥è§’è‰²çŠ¶æ€ï¼ˆä¸èƒ½åœ¨åƒµç›´ã€æµ®ç©ºç­‰çŠ¶æ€ä¸‹ä½¿ç”¨ï¼‰
    if(obj.sq_IsDownState() || obj.sq_IsHoldState()) return false;
    
    return true;
}
```

### 2. onSetState_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šæŠ€èƒ½çŠ¶æ€è®¾ç½®æ—¶çš„æ ¸å¿ƒå¤„ç†å‡½æ•°

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: è§’è‰²å¯¹è±¡
- `state`: å½“å‰çŠ¶æ€
- `datas`: çŠ¶æ€æ•°æ®æ•°ç»„
- `isResetTimer`: æ˜¯å¦é‡ç½®è®¡æ—¶å™¨

**å®é™…åº”ç”¨**ï¼š
```nut
function onSetState_SkillName(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    // æ ¹æ®ä¸åŒçŠ¶æ€æ‰§è¡Œä¸åŒé€»è¾‘
    if(state == STATE_SKILL_CAST)
    {
        // è®¾ç½®åŠ¨ç”»
        obj.sq_SetCurrentAnimation(ANIMATION_SKILL_CAST);
        
        // åœæ­¢ç§»åŠ¨
        obj.sq_StopMove();
        
        // è®¾ç½®æ— æ•ŒçŠ¶æ€ï¼ˆå¯é€‰ï¼‰
        obj.sq_SetCurrentAttackInfo(ATTACKINFO_INVINCIBLE);
        
        // æ¶ˆè€—MP
        local needMp = obj.sq_GetIntData(SKILL_SKILLNAME, SKL_MP_CONSUMPTION);
        obj.sq_AddMp(-needMp);
        
        // è®¾ç½®æŠ€èƒ½å†·å´
        obj.sq_UseSkill(SKILL_SKILLNAME, true);
    }
    else if(state == STATE_SKILL_ATTACK)
    {
        // æ”»å‡»é˜¶æ®µé€»è¾‘
        obj.sq_SetCurrentAnimation(ANIMATION_SKILL_ATTACK);
        
        // åˆ›å»ºæ”»å‡»åˆ¤å®š
        createAttackBox(obj);
    }
}
```

### 3. onEndCurrentAni_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šå½“å‰åŠ¨ç”»ç»“æŸæ—¶çš„å¤„ç†å‡½æ•°

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: è§’è‰²å¯¹è±¡

**å®é™…åº”ç”¨**ï¼š
```nut
function onEndCurrentAni_SkillName(obj)
{
    if(!obj) return;
    
    // åŠ¨ç”»ç»“æŸåçš„çŠ¶æ€è½¬æ¢
    local state = obj.sq_GetState();
    
    if(state == STATE_SKILL_CAST)
    {
        // æ–½æ³•åŠ¨ç”»ç»“æŸï¼Œè½¬å…¥æ”»å‡»çŠ¶æ€
        obj.sq_AddSetStatePacket(STATE_SKILL_ATTACK, STATE_PRIORITY_USER, true);
    }
    else if(state == STATE_SKILL_ATTACK)
    {
        // æ”»å‡»åŠ¨ç”»ç»“æŸï¼Œè¿”å›ç«™ç«‹çŠ¶æ€
        obj.sq_AddSetStatePacket(STATE_STAND, STATE_PRIORITY_USER, true);
    }
}
```

### 4. onKeyFrameFlag_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šåŠ¨ç”»å…³é”®å¸§è§¦å‘æ—¶çš„å¤„ç†å‡½æ•°

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: è§’è‰²å¯¹è±¡
- `flagIndex`: å…³é”®å¸§ç´¢å¼•

**å®é™…åº”ç”¨**ï¼š
```nut
function onKeyFrameFlag_SkillName(obj, flagIndex)
{
    if(!obj) return;
    
    // æ ¹æ®ä¸åŒå…³é”®å¸§æ‰§è¡Œä¸åŒé€»è¾‘
    switch(flagIndex)
    {
        case 1:
            // ç¬¬ä¸€ä¸ªå…³é”®å¸§ï¼šåˆ›å»ºç‰¹æ•ˆ
            createSkillEffect(obj);
            break;
            
        case 2:
            // ç¬¬äºŒä¸ªå…³é”®å¸§ï¼šåˆ›å»ºæ”»å‡»åˆ¤å®š
            createAttackBox(obj);
            break;
            
        case 3:
            // ç¬¬ä¸‰ä¸ªå…³é”®å¸§ï¼šæ’­æ”¾éŸ³æ•ˆ
            obj.sq_PlaySound(`SKILL_SOUND`);
            break;
    }
}
```

### 5. onAttack_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šè§’è‰²æ”»å‡»æ—¶çš„å¤„ç†å‡½æ•°

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: æ”»å‡»è€…å¯¹è±¡
- `damager`: è¢«æ”»å‡»è€…å¯¹è±¡
- `boundingBox`: æ”»å‡»èŒƒå›´
- `isStuck`: æ˜¯å¦å¡ä½

**å®é™…åº”ç”¨**ï¼š
```nut
function onAttack_SkillName(obj, damager, boundingBox, isStuck)
{
    if(!obj || !damager) return;
    
    // è·å–æŠ€èƒ½ç­‰çº§
    local skillLevel = obj.sq_GetSkillLevel(SKILL_SKILLNAME);
    
    // è®¡ç®—ä¼¤å®³
    local damage = calculateSkillDamage(obj, skillLevel);
    
    // åº”ç”¨ä¼¤å®³
    damager.sq_AddDamage(damage);
    
    // æ·»åŠ çŠ¶æ€æ•ˆæœï¼ˆå¦‚å†°å†»ã€ç‡ƒçƒ§ç­‰ï¼‰
    if(skillLevel >= 5)
    {
        // é«˜ç­‰çº§æŠ€èƒ½é™„åŠ ç‰¹æ®Šæ•ˆæœ
        sq_AppendAppendage(damager, obj, APPENDAGE_FREEZE, true, `freeze.ap`, true);
    }
    
    // å‡»é€€æ•ˆæœ
    local pushPower = obj.sq_GetIntData(SKILL_SKILLNAME, SKL_PUSH_POWER);
    damager.sq_AddForce(pushPower, 0);
}
```

## ğŸ® å›è°ƒå‡½æ•°ç³»ç»Ÿ

### è§’è‰²å›è°ƒå‡½æ•°
åŸºäºDAFå­¦é™¢æ•™ç¨‹ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨çš„è§’è‰²å›è°ƒå‡½æ•°ï¼š

#### 1. drawMainCustomUI_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šåœ¨åŸé•‡å’Œå‰¯æœ¬å†…éƒ½æŒç»­å¾ªç¯æ‰§è¡Œçš„UIç»˜åˆ¶å‡½æ•°

**ä½¿ç”¨åœºæ™¯**ï¼š
- å…¨å±€UIæ˜¾ç¤ºï¼ˆå¦‚è¡€æ¡ã€çŠ¶æ€æ˜¾ç¤ºï¼‰
- æŒç»­æ€§ç‰¹æ•ˆç»˜åˆ¶
- å…¨å±€çŠ¶æ€ç›‘æ§

```nut
function drawMainCustomUI_Swordman(obj)
{
    if(!obj) return;
    
    // ç»˜åˆ¶è‡ªå®šä¹‰è¡€æ¡
    drawCustomHealthBar(obj);
    
    // ç»˜åˆ¶æŠ€èƒ½å†·å´æ˜¾ç¤º
    drawSkillCooldown(obj);
}
```

#### 2. drawCustomUI_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šä»…åœ¨å‰¯æœ¬å†…æŒç»­å¾ªç¯æ‰§è¡Œçš„UIç»˜åˆ¶å‡½æ•°

**ä½¿ç”¨åœºæ™¯**ï¼š
- å‰¯æœ¬å†…ä¸“ç”¨UI
- æˆ˜æ–—çŠ¶æ€æ˜¾ç¤º
- å‰¯æœ¬ç‰¹æ®Šæ•ˆæœ

```nut
function drawCustomUI_Swordman(obj)
{
    if(!obj) return;
    
    // ä»…åœ¨å‰¯æœ¬å†…æ˜¾ç¤ºçš„æˆ˜æ–—ä¿¡æ¯
    drawBattleInfo(obj);
    
    // æ˜¾ç¤ºè¿å‡»æ•°
    drawComboCounter(obj);
}
```

#### 3. onStartDungeon_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šå‰¯æœ¬å¼€å§‹æ—¶è°ƒç”¨ä¸€æ¬¡

```nut
function onStartDungeon_Swordman(obj)
{
    if(!obj) return;
    
    // å‰¯æœ¬å¼€å§‹æ—¶çš„åˆå§‹åŒ–
    initializeDungeonBuffs(obj);
    
    // é‡ç½®æŠ€èƒ½å†·å´
    resetAllSkillCooldown(obj);
}
```

#### 4. onStartMap_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šæ¯ä¸ªæˆ¿é—´å¼€å§‹æ—¶è°ƒç”¨ä¸€æ¬¡

```nut
function onStartMap_Swordman(obj)
{
    if(!obj) return;
    
    // æˆ¿é—´å¼€å§‹æ—¶çš„å¤„ç†
    applyRoomBuffs(obj);
    
    // æ¢å¤éƒ¨åˆ†MP
    local currentMp = obj.sq_GetMp();
    obj.sq_SetMp(currentMp + 100);
}
```

#### 5. procAppend_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šåœ¨å‰¯æœ¬å†…æŒç»­å¾ªç¯è°ƒç”¨ï¼Œç”¨äºAPåŠ è½½

```nut
function procAppend_Swordman(obj)
{
    if(!obj) return;
    
    // æ£€æŸ¥å¹¶åº”ç”¨æŒç»­æ€§æ•ˆæœ
    checkAndApplyPassiveEffects(obj);
    
    // ç›‘æ§è§’è‰²çŠ¶æ€
    monitorCharacterStatus(obj);
}
```

## ğŸ“¦ APï¼ˆAppendageï¼‰ç³»ç»Ÿè¯¦è§£

### APç³»ç»Ÿæ¦‚å¿µ
APå¯ä»¥ç†è§£ä¸ºç»™å¯¹è±¡è£…ä¸Šçš„"ç›‘æ§å™¨"ï¼Œèƒ½å¤Ÿç›‘è§†å¯¹è±¡çš„ä¸€ä¸¾ä¸€åŠ¨å¹¶æ‰§è¡Œç›¸åº”æ“ä½œã€‚

### APåˆ›å»ºè¯­æ³•
```nut
sq_AppendAppendage(obj1, obj2, id, false, `apæ–‡ä»¶å`, true);
```

**å‚æ•°è¯´æ˜**ï¼š
- `obj1`: è¢«ç›‘æ§çš„å¯¹è±¡ï¼ˆç›‘æ§è£…ç»™è°ï¼‰
- `obj2`: ç›‘æ§çš„åˆ›å»ºè€…ï¼ˆè°è£…çš„ç›‘æ§ï¼‰
- `id`: ç›‘æ§çš„å”¯ä¸€æ ‡è¯†ï¼ˆç›‘æ§çš„å“ç‰Œï¼‰
- `apæ–‡ä»¶å`: APæ–‡ä»¶è·¯å¾„ï¼ˆç›‘æ§ä»å“ªé‡Œä¹°æ¥çš„ï¼‰

### APå‡½æ•°æ‰§è¡Œé¡ºåº
æ ¹æ®DAFå­¦é™¢æ•™ç¨‹ï¼ŒAPå‡½æ•°æœ‰å›ºå®šçš„æ‰§è¡Œé¡ºåºï¼š

1. **onStart**: APåˆšå¼€å§‹æ—¶æ‰§è¡Œä¸€æ¬¡
2. **onStartMap**: è¿›å…¥æ¯ä¸ªå‰¯æœ¬æˆ¿é—´æ—¶æ‰§è¡Œä¸€æ¬¡
3. **proc**: APç©ºé—²æ—¶å¾ªç¯æ‰§è¡Œï¼ˆé˜»å¡æ–¹æ³•ï¼‰
4. **onSetHp**: å¯¹è±¡è¡€é‡å˜åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
5. **prepareDraw**: å‡†å¤‡ç»˜åˆ¶æ—¶å¾ªç¯æ‰§è¡Œ
6. **drawAppend**: ç»˜åˆ¶APæ—¶å¾ªç¯æ‰§è¡Œ
7. **onChangeState**: å¯¹è±¡æ”¹å˜çŠ¶æ€æ—¶æ‰§è¡Œä¸€æ¬¡
8. **onApplyHpDamage**: å¯¹è±¡å—åˆ°ä¼¤å®³æ—¶æ‰§è¡Œä¸€æ¬¡
9. **onAttackParent**: å¯¹è±¡æ”»å‡»æ—¶æ‰§è¡Œä¸€æ¬¡
10. **onDamageParent**: å¯¹è±¡å—åˆ°ä¼¤å®³æ—¶æ‰§è¡Œä¸€æ¬¡
11. **getImmuneTypeDamageRate**: è·å–å±æ€§æ”»å‡»æ¯”ç‡æ—¶æ‰§è¡Œä¸€æ¬¡
12. **onVaildTimeEnd**: ç›‘æ§å¤±æ•ˆæ—¶æ‰§è¡Œä¸€æ¬¡
13. **onDestroyObject**: å¯¹è±¡å—åˆ°æ”»å‡»æ—¶æ‰§è¡Œä¸€æ¬¡
14. **isEnd**: åˆ¤æ–­APæ˜¯å¦ç»“æŸ
15. **onEnd**: è¿”å›åŸé•‡æˆ–å¯¹è±¡æ­»äº¡æ—¶æ‰§è¡Œä¸€æ¬¡

### APæ¨¡æ¿ç¤ºä¾‹
```nut
// APæ–‡ä»¶åŸºæœ¬ç»“æ„
appendage.sq_AddFunctionName(`onStart`, ``);
appendage.sq_AddFunctionName(`onStartMap`, ``);
appendage.sq_AddFunctionName(`proc`, ``);
appendage.sq_AddFunctionName(`onSetHp`, ``);
appendage.sq_AddFunctionName(`prepareDraw`, ``);
appendage.sq_AddFunctionName(`drawAppend`, ``);
appendage.sq_AddFunctionName(`onChangeState`, ``);
appendage.sq_AddFunctionName(`onApplyHpDamage`, ``);
appendage.sq_AddFunctionName(`onAttackParent`, ``);
appendage.sq_AddFunctionName(`onDamageParent`, ``);
appendage.sq_AddFunctionName(`getImmuneTypeDamageRate`, ``);
appendage.sq_AddFunctionName(`onSourceKeyFrameFlag`, ``);
appendage.sq_AddFunctionName(`onVaildTimeEnd`, ``);
appendage.sq_AddFunctionName(`onDestroyObject`, ``);
appendage.sq_AddFunctionName(`isEnd`, ``);
appendage.sq_AddFunctionName(`onEnd`, ``);

function onStart_ap(appendage)
{
    if(!appendage) return;
    
    local obj = appendage.getParent();
    if(!obj) return;
    
    // APå¼€å§‹æ—¶çš„åˆå§‹åŒ–é€»è¾‘
    appendage.sq_SetValidTime(5000); // è®¾ç½®APæŒç»­æ—¶é—´5ç§’
}

function proc_ap(appendage)
{
    if(!appendage) return;
    
    local obj = appendage.getParent();
    if(!obj) return;
    
    // æŒç»­æ‰§è¡Œçš„é€»è¾‘
    // ä¾‹å¦‚ï¼šæŒç»­å›è¡€ã€æŒç»­ä¼¤å®³ç­‰
}

function onEnd_ap(appendage)
{
    if(!appendage) return;
    
    local obj = appendage.getParent();
    if(!obj) return;
    
    // APç»“æŸæ—¶çš„æ¸…ç†é€»è¾‘
    removeBuffEffects(obj);
}
```
- `datas`: çŠ¶æ€æ•°æ®
- `isResetTimer`: æ˜¯å¦é‡ç½®è®¡æ—¶å™¨

**å®é™…åº”ç”¨**ï¼š
```nut
function onSetState_SkillName(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    // è®¾ç½®åŠ¨ç”»
    obj.sq_SetCurrentAnimation(CUSTOM_ANI_SKILLNAME);
    
    // è®¾ç½®ç§»åŠ¨çŠ¶æ€
    obj.sq_StopMove();
    
    // è®¾ç½®è®¡æ—¶å™¨
    obj.sq_SetStaticSpeedInfo(SPEED_TYPE_ATTACK_SPEED, 
        SPEED_TYPE_ATTACK_SPEED, SPEED_VALUE_DEFAULT, 
        SPEED_VALUE_DEFAULT, 1.0, 1.0);
}
```

### 3. onAttack_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šå¤„ç†æ”»å‡»åˆ¤å®šå’Œä¼¤å®³è®¡ç®—

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: æ”»å‡»è€…å¯¹è±¡
- `damager`: ä¼¤å®³å¯¹è±¡
- `boundingBox`: æ”»å‡»èŒƒå›´
- `isStuck`: æ˜¯å¦é€ æˆç¡¬ç›´

**å®é™…åº”ç”¨**ï¼š
```nut
function onAttack_SkillName(obj, damager, boundingBox, isStuck)
{
    if(!obj || !damager) return;
    
    // è®¾ç½®ä¼¤å®³å€ç‡
    damager.sq_SetDamageRate(120); // 120%ä¼¤å®³
    
    // è®¾ç½®æ”»å‡»å±æ€§
    damager.sq_SetAttackInfo(SAI_IS_MAGIC, true);
    
    // æ·»åŠ çŠ¶æ€æ•ˆæœ
    damager.sq_SetChangeStatusIntoAttackInfo(ACTIVESTATUS_STUCK, 
        0, 200, 1000, 0);
}
```

### 4. onTimeEvent_* ç³»åˆ—
**åŠŸèƒ½ä½œç”¨**ï¼šå¤„ç†æ—¶é—´äº‹ä»¶å’ŒçŠ¶æ€è½¬æ¢

**å‚æ•°è¯¦è§£**ï¼š
- `obj`: è§’è‰²å¯¹è±¡
- `timeEventIndex`: æ—¶é—´äº‹ä»¶ç´¢å¼•
- `timeEventCount`: äº‹ä»¶è®¡æ•°

**å®é™…åº”ç”¨**ï¼š
```nut
function onTimeEvent_SkillName(obj, timeEventIndex, timeEventCount)
{
    if(!obj) return;
    
    switch(timeEventIndex)
    {
        case TIMER_ATTACK_START:
            // å¼€å§‹æ”»å‡»åˆ¤å®š
            obj.sq_StartWrite();
            obj.sq_WriteDword(timeEventIndex);
            obj.sq_SendCreatePassiveObjectPacket(24210, 0, 0, 0, 0);
            break;
            
        case TIMER_SKILL_END:
            // æŠ€èƒ½ç»“æŸ
            obj.sq_AddSetStatePacket(STATE_STAND, STATE_PRIORITY_USER, true);
            break;
    }
}
```

## ğŸ“Š å¸¸ç”¨å¯¹è±¡æ–¹æ³•

### obj å¯¹è±¡æ ¸å¿ƒæ–¹æ³•

#### çŠ¶æ€æ§åˆ¶
- `obj.sq_AddSetStatePacket(state, priority, isResetTimer)`: è®¾ç½®çŠ¶æ€
- `obj.sq_SetCurrentAnimation(aniIndex)`: è®¾ç½®åŠ¨ç”»
- `obj.sq_StopMove()`: åœæ­¢ç§»åŠ¨
- `obj.sq_SetStaticSpeedInfo()`: è®¾ç½®é€Ÿåº¦ä¿¡æ¯

#### æŠ€èƒ½æ£€æŸ¥
- `obj.sq_IsUseSkill(skillIndex)`: æ£€æŸ¥æŠ€èƒ½æ˜¯å¦åœ¨ä½¿ç”¨
- `obj.sq_GetSkillLevel(skillIndex)`: è·å–æŠ€èƒ½ç­‰çº§
- `obj.sq_GetMp()`: è·å–å½“å‰MP
- `obj.sq_GetIntData(skillIndex, dataType)`: è·å–æŠ€èƒ½æ•°æ®

#### æ•°æ®ä¼ è¾“
- `obj.sq_StartWrite()`: å¼€å§‹å†™å…¥æ•°æ®
- `obj.sq_WriteDword(value)`: å†™å…¥32ä½æ•´æ•°
- `obj.sq_WriteFloat(value)`: å†™å…¥æµ®ç‚¹æ•°
- `obj.sq_SendCreatePassiveObjectPacket()`: å‘é€åˆ›å»ºè¢«åŠ¨å¯¹è±¡åŒ…

### damager å¯¹è±¡æ ¸å¿ƒæ–¹æ³•

#### ä¼¤å®³è®¾ç½®
- `damager.sq_SetDamageRate(rate)`: è®¾ç½®ä¼¤å®³å€ç‡
- `damager.sq_SetAttackInfo(type, value)`: è®¾ç½®æ”»å‡»ä¿¡æ¯
- `damager.sq_SetHitInfo(type, value)`: è®¾ç½®å‘½ä¸­ä¿¡æ¯

#### çŠ¶æ€æ•ˆæœ
- `damager.sq_SetChangeStatusIntoAttackInfo()`: æ·»åŠ çŠ¶æ€æ•ˆæœ
- `damager.sq_SetKnockInfo()`: è®¾ç½®å‡»é€€ä¿¡æ¯

## ğŸ® å¸¸ç”¨å¸¸é‡å®šä¹‰

### æ”»å‡»ç±»å‹å¸¸é‡
```nut
PHYSICAL_ATTACK <- 0        // ç‰©ç†æ”»å‡»
MAGICAL_ATTACK <- 1         // é­”æ³•æ”»å‡»
PHYSICAL_DEFENSE <- 3       // ç‰©ç†é˜²å¾¡
MAGICAL_DEFENSE <- 2        // é­”æ³•é˜²å¾¡
```

### å…ƒç´ å±æ€§å¸¸é‡
```nut
ELEMENT_ATTACK_FIRE <- 42   // ç«å±æ€§æ”»å‡»
ELEMENT_ATTACK_WATER <- 43  // æ°´å±æ€§æ”»å‡»
ELEMENT_ATTACK_DARK <- 44   // æš—å±æ€§æ”»å‡»
ELEMENT_ATTACK_LIGHT <- 45  // å…‰å±æ€§æ”»å‡»
```

### çŠ¶æ€æ•ˆæœå¸¸é‡
```nut
ACTIVESTATUS_STUCK <- 27           // ç¡¬ç›´çŠ¶æ€
ACTIVESTATUS_TOLERANCE_ALL <- 26   // å…¨æŠ—æ€§å¢åŠ 
DISEASE <- 47                      // ä¸­æ¯’çŠ¶æ€
RIGIDITY <- 41                     // åƒµç›´çŠ¶æ€
```

### é€Ÿåº¦ç±»å‹å¸¸é‡
```nut
SPEED_TYPE_ATTACK_SPEED <- 10   // æ”»å‡»é€Ÿåº¦
SPEED_TYPE_MOVE_SPEED <- 11     // ç§»åŠ¨é€Ÿåº¦
SPEED_TYPE_CAST_SPEED <- 12     // æ–½æ³•é€Ÿåº¦
```

## ğŸ”— ä¾èµ–å…³ç³»

### æ–‡ä»¶ä¾èµ–
- **header.nut**: çŠ¶æ€å’ŒæŠ€èƒ½å¸¸é‡å®šä¹‰
- **chræ–‡ä»¶**: åŠ¨ç”»åºåˆ—å·å¯¹åº”
- **skillæ–‡ä»¶**: æŠ€èƒ½åŸºç¡€æ•°æ®
- **passiveobject**: è¢«åŠ¨å¯¹è±¡åˆ›å»º

### çŠ¶æ€ä¾èµ–
- STATEå®šä¹‰å¿…é¡»åœ¨header.nutä¸­æ³¨å†Œ
- ANIåºåˆ—å·å¿…é¡»ä¸chræ–‡ä»¶å¯¹åº”
- SKILLå¸¸é‡å¿…é¡»ä¸æŠ€èƒ½ä»£ç åŒ¹é…

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

1. **çŠ¶æ€ç¼–å·å†²çª**: STATEå®šä¹‰çš„ç¼–å·ä¸èƒ½ä¸ç°æœ‰ä»£ç å†²çª
2. **åŠ¨ç”»åºåˆ—**: ANIåºåˆ—å·éœ€è¦æ¯”chræ–‡ä»¶ä¸­çš„ä½ç½®å‡1
3. **å‡½æ•°å‘½å**: å‡½æ•°åå¿…é¡»ä¸æŠ€èƒ½åç§°ä¿æŒä¸€è‡´
4. **å‚æ•°ç±»å‹**: ä¸¥æ ¼æŒ‰ç…§å‡½æ•°ç­¾åä¼ é€’å‚æ•°
5. **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†åˆ›å»ºçš„å¯¹è±¡å’Œæ•°æ®

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ¨¡å—åŒ–è®¾è®¡**: å°†å¤æ‚æŠ€èƒ½æ‹†åˆ†ä¸ºå¤šä¸ªå‡½æ•°
2. **é”™è¯¯æ£€æŸ¥**: å§‹ç»ˆæ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰æ•ˆ
3. **æ€§èƒ½ä¼˜åŒ–**: é¿å…åœ¨å¾ªç¯ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
4. **ä»£ç å¤ç”¨**: æå–å…¬å…±é€»è¾‘ä¸ºç‹¬ç«‹å‡½æ•°
5. **è°ƒè¯•æ”¯æŒ**: ä½¿ç”¨åŠ¨æ€è°ƒè¯•æŠ€æœ¯è¿›è¡Œå¼€å‘æµ‹è¯•

## ğŸš€ é«˜çº§æŠ€å·§ä¸å®æˆ˜ç»éªŒ

### åŠ¨æ€è°ƒè¯•æŠ€æœ¯

## ğŸ”§ DNFå¼•æ“è°ƒç”¨æœºåˆ¶åŸç†

### è„šæœ¬åŠ è½½æœºåˆ¶

#### å…¥å£æ–‡ä»¶ç³»ç»Ÿ
- **loadstate.nut**: DNFè„šæœ¬åŠ è½½çš„æ ¸å¿ƒå…¥å£æ–‡ä»¶
  - è·¯å¾„: `sqr/loadstate.nut`
  - åŠŸèƒ½: å¼•æ“å¯åŠ¨æ—¶è‡ªåŠ¨é¢„åŠ è½½ï¼Œè´Ÿè´£åç»­è„šæœ¬æ–‡ä»¶çš„åŠ è½½
  - ä½œç”¨: ç±»ä¼¼ç¼–ç¨‹è¯­è¨€ä¸­çš„"å¤´æ–‡ä»¶/å¼•ç”¨åŒ…"

#### è„šæœ¬è¿è¡Œå‡½æ•°å¯¹æ¯”

**sq_RunScript() vs dofile()**

| ç‰¹æ€§ | sq_RunScript() | dofile() |
|------|----------------|----------|
| ç”¨é€” | åŠ è½½æ¸¸æˆå°åŒ…å†…çš„.nutè„šæœ¬ | åŠ è½½æ–‡ä»¶ç³»ç»Ÿä¸­çš„.nutè„šæœ¬ |
| è·¯å¾„è§„åˆ™ | åŸºäºæ¸¸æˆèµ„æºç›®å½•çš„ç›¸å¯¹è·¯å¾„ | ç»å¯¹è·¯å¾„æˆ–é¡¹ç›®ç›¸å¯¹è·¯å¾„ |
| è¯»å–é€Ÿåº¦ | å†…å­˜å°åŒ…è¯»å–ï¼Œé€Ÿåº¦å¿« | ä¾èµ–ç£ç›˜I/Oï¼Œé€Ÿåº¦è¾ƒæ…¢ |
| ä¿®æ”¹ç”Ÿæ•ˆ | éœ€é‡æ–°æ‰“åŒ…PVFæ–‡ä»¶ | å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é¢å¤–æ“ä½œ |
| é€‚ç”¨åœºæ™¯ | æˆå“è„šæœ¬ï¼ˆè¿½æ±‚æ€§èƒ½ï¼‰ | å¼€å‘/æµ‹è¯•é˜¶æ®µï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰ |

### è„šæœ¬åŠ è½½ç­–ç•¥

#### pushScriptFiles vs pushState

**pushScriptFilesï¼ˆé¢„åŠ è½½ç­–ç•¥ï¼‰**
- åŠ è½½æ–¹å¼: å…¨å±€é¢„åŠ è½½ï¼Œç±»ä¼¼"å…¨å±€å˜é‡"
- å†…å­˜å¼€é”€: å§‹ç»ˆå ç”¨å†…å­˜ï¼Œå¼€é”€è¾ƒå¤§
- è§¦å‘æ–¹å¼: éœ€å¼€å‘è€…æ‰‹åŠ¨æ£€æµ‹çŠ¶æ€ID
- é€‚ç”¨åœºæ™¯: é€»è¾‘é€šç”¨ã€éœ€å…¨å±€å¤ç”¨çš„è„šæœ¬

**pushStateï¼ˆåŠ¨æ€åŠ è½½ç­–ç•¥ï¼‰**
- åŠ è½½æ–¹å¼: çŠ¶æ€è§¦å‘æ—¶åŠ¨æ€åŠ è½½
- å†…å­˜å¼€é”€: ä»…çŠ¶æ€æ¿€æ´»æ—¶å ç”¨å†…å­˜ï¼Œæ•ˆç‡é«˜
- è§¦å‘æ–¹å¼: æ£€æµ‹åˆ°æŒ‡å®šçŠ¶æ€åå¼•æ“è‡ªåŠ¨è°ƒç”¨
- é€‚ç”¨åœºæ™¯: ç‰¹å®šçŠ¶æ€è§¦å‘çš„è„šæœ¬ï¼ˆå¦‚æŠ€èƒ½é‡Šæ”¾ï¼‰

### DNFå¼•æ“åŒè½¨è§¦å‘æœºåˆ¶

#### ç¬¬ä¸€è½¨ï¼šå‡½æ•°ç­¾åé©±åŠ¨æœºåˆ¶ï¼ˆä¸»è¦æ–¹å¼ï¼‰

**æ ¸å¿ƒåŸç†**
- å¼•æ“é€šè¿‡é¢„å®šä¹‰çš„å‡½æ•°åæ¨¡å¼æ‰«æå…¨å±€å·²åŠ è½½è„šæœ¬
- å‡½æ•°å­˜åœ¨ä¸”ç­¾ååŒ¹é…æ—¶ï¼Œæ— éœ€æ³¨å†Œå³å¯è‡ªåŠ¨è°ƒç”¨
- ä¸å‡½æ•°æ‰€åœ¨æ–‡ä»¶ä½ç½®æ— å…³

**è¯†åˆ«è§„åˆ™**
- å‡½æ•°åæ ¼å¼: "äº‹ä»¶å‰ç¼€ + è§’è‰²/åœºæ™¯æ ‡è¯†"
- è§¦å‘æ¡ä»¶: å¯¹åº”æ¸¸æˆäº‹ä»¶å‘ç”Ÿ

**å¸¸ç”¨å‡½æ•°ç­¾åæ¨¡å¼**
```nut
// æŠ€èƒ½é‡Šæ”¾åè§¦å‘
function useSkill_after_èŒä¸šå(obj, skill, damager)

// è§’è‰²å—ä¼¤æ—¶è§¦å‘  
function onDamage_èŒä¸šå(obj, damager, damage)

// å…¨å±€çŠ¶æ€å¼€å§‹æ—¶å›è°ƒ
function onStateStart(obj, state, datas)

// çŠ¶æ€æ›´æ–°æ—¶è§¦å‘
function onSetState_èŒä¸šå(obj, state, datas)

// æ”»å‡»å‘½ä¸­æ—¶è§¦å‘
function onAttack_èŒä¸šå(obj, damager, target)
```

#### ç¬¬äºŒè½¨ï¼šçŠ¶æ€æ³¨å†Œé©±åŠ¨æœºåˆ¶ï¼ˆè¾…åŠ©æ–¹å¼ï¼‰

**æ ¸å¿ƒåŸç†**
- éœ€å…ˆé€šè¿‡pushStateå»ºç«‹"çŠ¶æ€IDä¸è„šæœ¬"çš„æ˜ å°„å…³ç³»
- ä»…å½“æŒ‡å®šçŠ¶æ€æ¿€æ´»æ—¶ï¼Œå¼•æ“æ‰ä¼šè°ƒç”¨å¯¹åº”å‡½æ•°
- å±äº"ä¾èµ–æ³¨å†Œçš„å®šå‘è§¦å‘"

**æ³¨å†Œè¯­æ³•**
```nut
IRDSQRCharacter.pushState(
    èŒä¸šæšä¸¾,           // æŒ‡å®šèŒä¸š
    "è„šæœ¬æ–‡ä»¶è·¯å¾„",      // è„šæœ¬æ–‡ä»¶è·¯å¾„
    "å‡½æ•°å‰ç¼€",         // å‡½æ•°å‰ç¼€
    çŠ¶æ€ç±»å‹,           // å¤„ç†çš„çŠ¶æ€ç±»å‹
    ä¼˜å…ˆçº§              // ä¼˜å…ˆçº§ï¼ˆ-1ä¸ºé»˜è®¤ï¼‰
);
```

**è‡ªåŠ¨è°ƒç”¨è§„åˆ™**
| å‡½æ•°æ ¼å¼ | è§¦å‘æ—¶æœº | è¯´æ˜ |
|----------|----------|------|
| onStart_å‰ç¼€ | çŠ¶æ€å¼€å§‹æ—¶ | çŠ¶æ€åˆå§‹åŒ– |
| proc_å‰ç¼€ | çŠ¶æ€æŒç»­ä¸­ | æ¯å¸§æ›´æ–° |
| onEnd_å‰ç¼€ | çŠ¶æ€ç»“æŸæ—¶ | çŠ¶æ€æ¸…ç† |
| onAfterSetState_å‰ç¼€ | çŠ¶æ€è®¾ç½®å®Œæˆå | çŠ¶æ€åå¤„ç† |

### å¼•æ“è°ƒç”¨æœºåˆ¶æœ€ä½³å®è·µ

#### å¼€å‘é˜¶æ®µå»ºè®®
1. **åŠ è½½å‡½æ•°é€‰æ‹©**
   - å¼€å‘/æµ‹è¯•: ä½¿ç”¨dofile()ï¼ˆå®æ—¶ç”Ÿæ•ˆï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
   - æˆå“è„šæœ¬: æ”¹ç”¨sq_RunScript()ï¼ˆæå‡æ€§èƒ½ï¼‰

2. **åŠ è½½ç­–ç•¥é€‰æ‹©**
   - é€šç”¨é€»è¾‘: ä½¿ç”¨pushScriptFilesï¼ˆå…¨å±€é¢„åŠ è½½ï¼‰
   - ç‰¹å®šçŠ¶æ€: ä½¿ç”¨pushStateï¼ˆåŠ¨æ€åŠ è½½ï¼ŒèŠ‚çœå†…å­˜ï¼‰

3. **å‡½æ•°å‘½åè§„èŒƒ**
   - ä¸¥æ ¼éµå¾ª"äº‹ä»¶å‰ç¼€ + èŒä¸šå"æ ¼å¼
   - é¿å…å¼•æ“æ— æ³•è¯†åˆ«å‡½æ•°ç­¾å

#### æ€§èƒ½ä¼˜åŒ–è¦ç‚¹
1. **å†…å­˜ç®¡ç†**: ä¼˜å…ˆä½¿ç”¨pushStateå‡å°‘å†…å­˜å ç”¨
2. **å“åº”é€Ÿåº¦**: å‡½æ•°ç­¾åé©±åŠ¨æ¯”æ‰‹åŠ¨æ£€æµ‹æ›´å¿«
3. **æ–‡ä»¶ç»„ç»‡**: ç›¸å…³åŠŸèƒ½çš„è„šæœ¬æ–‡ä»¶é›†ä¸­ç®¡ç†

#### å¸¸è§é™·é˜±é¿å…
1. **çŠ¶æ€åŒ¹é…**: çŠ¶æ€æ³¨å†Œæ—¶çš„çŠ¶æ€ç±»å‹éœ€ä¸æŠ€èƒ½indexåŒ¹é…
2. **å‡½æ•°ç­¾å**: å‡½æ•°åæ‹¼å†™é”™è¯¯ä¼šå¯¼è‡´å¼•æ“æ— æ³•è¯†åˆ«
3. **æ–‡ä»¶è·¯å¾„**: æ³¨æ„ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„çš„åŒºåˆ«

### åŠ¨æ€è°ƒè¯•æŠ€æœ¯
åŸºäºDAFå­¦é™¢æ•™ç¨‹çš„åŠ¨æ€è°ƒè¯•æ–¹æ³•ï¼Œå¯ä»¥å®ç°ä¸é‡å¯æ¸¸æˆçš„å®æ—¶è°ƒè¯•ï¼š

```nut
// åœ¨æŠ€èƒ½å‡½æ•°ä¸­è°ƒç”¨å¤–éƒ¨æ–‡ä»¶
function onSetState_WindStrike(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    // åŠ¨æ€åŠ è½½å¤–éƒ¨è°ƒè¯•æ–‡ä»¶
    dofile(`test.nut`);
    
    // è°ƒç”¨å¤–éƒ¨å®šä¹‰çš„å‡½æ•°
    setStateWindStrike(obj);
}
```

**å¤–éƒ¨test.nutæ–‡ä»¶**ï¼š
```nut
function setStateWindStrike(obj)
{
    // åœ¨è¿™é‡Œç¼–å†™å®é™…çš„æŠ€èƒ½é€»è¾‘
    // ä¿®æ”¹æ­¤æ–‡ä»¶åæ— éœ€é‡å¯æ¸¸æˆå³å¯ç”Ÿæ•ˆ
    obj.sq_SetCurrentAnimation(ANIMATION_WINDSTRIKE);
    obj.sq_StopMove();
}
```

### å‡½æ•°åˆå¹¶æŠ€å·§
å½“å¤šä¸ªMODä½¿ç”¨ç›¸åŒçš„å›è°ƒå‡½æ•°æ—¶ï¼Œéœ€è¦è¿›è¡Œå‡½æ•°åˆå¹¶ï¼š

#### åˆå¹¶å‰ï¼ˆå†²çªï¼‰ï¼š
```nut
// MOD A
function drawCustomUI_Swordman(obj)
{
    drawBloodBar(obj);
}

// MOD B
function drawCustomUI_Swordman(obj)
{
    drawSkillCooldown(obj);
}
```

#### åˆå¹¶åï¼ˆæ­£ç¡®ï¼‰ï¼š
```nut
function drawCustomUI_Swordman(obj)
{
    // åˆå¹¶æ‰€æœ‰åŠŸèƒ½
    drawBloodBar(obj);
    drawSkillCooldown(obj);
}
```

### å¤šåŠ¨ä½œæŠ€èƒ½å®ç°
å¤æ‚æŠ€èƒ½é€šå¸¸éœ€è¦å¤šä¸ªåŠ¨ä½œçŠ¶æ€ï¼š

```nut
// çŠ¶æ€å®šä¹‰
STATE_SKILL_READY <- 100    // å‡†å¤‡çŠ¶æ€
STATE_SKILL_CAST <- 101     // æ–½æ³•çŠ¶æ€
STATE_SKILL_ATTACK <- 102   // æ”»å‡»çŠ¶æ€
STATE_SKILL_END <- 103      // ç»“æŸçŠ¶æ€

function onSetState_ComplexSkill(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    switch(state)
    {
        case STATE_SKILL_READY:
            obj.sq_SetCurrentAnimation(ANI_SKILL_READY);
            obj.sq_AddSetStatePacket(STATE_SKILL_CAST, STATE_PRIORITY_USER, true);
            break;
            
        case STATE_SKILL_CAST:
            obj.sq_SetCurrentAnimation(ANI_SKILL_CAST);
            // è®¾ç½®æ–½æ³•æ—¶é—´
            obj.sq_SetStaticSpeedInfo(SPEED_TYPE_CAST_SPEED, 
                SPEED_TYPE_CAST_SPEED, SPEED_VALUE_DEFAULT, 
                SPEED_VALUE_DEFAULT, 1.0, 1.0);
            break;
            
        case STATE_SKILL_ATTACK:
            obj.sq_SetCurrentAnimation(ANI_SKILL_ATTACK);
            // åˆ›å»ºæ”»å‡»åˆ¤å®š
            createAttackArea(obj);
            break;
            
        case STATE_SKILL_END:
            obj.sq_SetCurrentAnimation(ANI_SKILL_END);
            obj.sq_AddSetStatePacket(STATE_STAND, STATE_PRIORITY_USER, true);
            break;
    }
}
```

### å¼ºåˆ¶ä¸­æ–­ä¸å…±å­˜æŠ€å·§
å®ç°æŠ€èƒ½çš„å¼ºåˆ¶ä¸­æ–­å’Œå…±å­˜æœºåˆ¶ï¼š

```nut
function checkCommandEnable_ForceSkill(obj)
{
    if(!obj) return false;
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼ºåˆ¶ä¸­æ–­å½“å‰çŠ¶æ€
    local currentState = obj.sq_GetState();
    
    // å…è®¸ä¸­æ–­çš„çŠ¶æ€åˆ—è¡¨
    local interruptableStates = [
        STATE_STAND,
        STATE_WALK,
        STATE_RUN,
        STATE_ATTACK  // å¯ä»¥ä¸­æ–­æ™®é€šæ”»å‡»
    ];
    
    // æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦å¯ä¸­æ–­
    foreach(state in interruptableStates)
    {
        if(currentState == state)
            return true;
    }
    
    return false;
}
```

### å±æ€§è®¡ç®—ä¸åŠ æˆ
å®ç°å¤æ‚çš„å±æ€§è®¡ç®—å’ŒæŠ€èƒ½åŠ æˆï¼š

```nut
function calculateSkillDamage(obj, skillLevel)
{
    if(!obj) return 0;
    
    // åŸºç¡€ä¼¤å®³
    local baseDamage = obj.sq_GetIntData(SKILL_SKILLNAME, SKL_BASIC_DAMAGE);
    
    // æŠ€èƒ½ç­‰çº§åŠ æˆ
    local levelBonus = skillLevel * 50;
    
    // è·å–è§’è‰²å±æ€§
    local physicalAttack = obj.sq_GetBonusRateWithPassive(PHYSICAL_ATTACK);
    local magicalAttack = obj.sq_GetBonusRateWithPassive(MAGICAL_ATTACK);
    
    // è®¡ç®—æœ€ç»ˆä¼¤å®³
    local finalDamage = (baseDamage + levelBonus) * (physicalAttack + magicalAttack) / 100;
    
    return finalDamage.tointeger();
}
```

### ç‰¹æ•ˆä¸éŸ³æ•ˆç®¡ç†
ç»Ÿä¸€ç®¡ç†æŠ€èƒ½çš„è§†è§‰å’ŒéŸ³æ•ˆæ•ˆæœï¼š

```nut
function createSkillEffects(obj, effectType)
{
    if(!obj) return;
    
    switch(effectType)
    {
        case EFFECT_CAST:
            // æ–½æ³•ç‰¹æ•ˆ
            obj.sq_StartWrite();
            obj.sq_WriteDword(EFFECT_CAST_ID);
            obj.sq_SendCreatePassiveObjectPacket(24210, 0, 0, 0, 0);
            
            // æ–½æ³•éŸ³æ•ˆ
            obj.sq_PlaySound(`SKILL_CAST_SOUND`);
            break;
            
        case EFFECT_HIT:
            // å‘½ä¸­ç‰¹æ•ˆ
            obj.sq_StartWrite();
            obj.sq_WriteDword(EFFECT_HIT_ID);
            obj.sq_SendCreatePassiveObjectPacket(24211, 0, 0, 0, 0);
            
            // å‘½ä¸­éŸ³æ•ˆ
            obj.sq_PlaySound(`SKILL_HIT_SOUND`);
            break;
    }
}
```

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### 1. å‡å°‘ä¸å¿…è¦çš„è®¡ç®—
```nut
// ä¸å¥½çš„åšæ³•
function proc_BadExample(appendage)
{
    local obj = appendage.getParent();
    if(!obj) return;
    
    // æ¯å¸§éƒ½è¿›è¡Œå¤æ‚è®¡ç®—
    local damage = calculateComplexDamage(obj);
    obj.sq_SetDamage(damage);
}

// å¥½çš„åšæ³•
function proc_GoodExample(appendage)
{
    local obj = appendage.getParent();
    if(!obj) return;
    
    // åªåœ¨éœ€è¦æ—¶è®¡ç®—
    if(appendage.getTimer() % 30 == 0) // æ¯30å¸§è®¡ç®—ä¸€æ¬¡
    {
        local damage = calculateComplexDamage(obj);
        appendage.setVar(`cachedDamage`, damage);
    }
    
    local damage = appendage.getVar(`cachedDamage`);
    obj.sq_SetDamage(damage);
}
```

#### 2. åˆç†ä½¿ç”¨APç”Ÿå‘½å‘¨æœŸ
```nut
function onStart_OptimizedAP(appendage)
{
    if(!appendage) return;
    
    // è®¾ç½®åˆç†çš„APæŒç»­æ—¶é—´
    appendage.sq_SetValidTime(5000); // 5ç§’åè‡ªåŠ¨æ¸…ç†
    
    // åˆå§‹åŒ–ç¼“å­˜æ•°æ®
    appendage.setVar(`initialized`, true);
}

function isEnd_OptimizedAP(appendage)
{
    if(!appendage) return true;
    
    local obj = appendage.getParent();
    if(!obj) return true;
    
    // æ£€æŸ¥å¯¹è±¡çŠ¶æ€ï¼ŒåŠæ—¶æ¸…ç†æ— æ•ˆAP
    if(obj.sq_GetHp() <= 0) return true;
    
    return false;
}
```

### è°ƒè¯•ä¸é”™è¯¯å¤„ç†

#### 1. è°ƒè¯•ä¿¡æ¯è¾“å‡º
```nut
function debugLog(message)
{
    // åœ¨å¼€å‘é˜¶æ®µè¾“å‡ºè°ƒè¯•ä¿¡æ¯
    if(DEBUG_MODE)
    {
        print(`[DEBUG] ` + message);
    }
}

function onSetState_DebugSkill(obj, state, datas, isResetTimer)
{
    debugLog(`Setting state: ` + state + ` for object: ` + obj);
    
    // å®é™…æŠ€èƒ½é€»è¾‘
    // ...
}
```

#### 2. é”™è¯¯æ¢å¤æœºåˆ¶
```nut
function safeExecuteSkill(obj, skillFunction)
{
    try
    {
        skillFunction(obj);
    }
    catch(error)
    {
        // é”™è¯¯å¤„ç†ï¼šæ¢å¤åˆ°å®‰å…¨çŠ¶æ€
        if(obj)
        {
            obj.sq_AddSetStatePacket(STATE_STAND, STATE_PRIORITY_USER, true);
        }
        
        debugLog(`Skill execution error: ` + error);
    }
}
```

## ğŸ“š å®æˆ˜æ¡ˆä¾‹å‚è€ƒ

### æ¡ˆä¾‹1ï¼šå†°éœœç©¿åˆºæŠ€èƒ½
```nut
// åŸºäºDAFæ•™ç¨‹çš„å†°éœœç©¿åˆºå®ç°
STATE_ICE_PIERCE <- 150

function checkExecutableSkill_IcePierce(obj)
{
    if(!obj) return false;
    if(obj.sq_GetMp() < 50) return false;
    if(obj.sq_IsUseSkill(SKILL_ICE_PIERCE)) return false;
    return true;
}

function onSetState_IcePierce(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    obj.sq_SetCurrentAnimation(ANI_ICE_PIERCE);
    obj.sq_StopMove();
    obj.sq_AddMp(-50);
    obj.sq_UseSkill(SKILL_ICE_PIERCE, true);
}

function onKeyFrameFlag_IcePierce(obj, flagIndex)
{
    if(!obj) return;
    
    if(flagIndex == 1)
    {
        // åˆ›å»ºå†°éœœç©¿åˆºæ•ˆæœ
        obj.sq_StartWrite();
        obj.sq_WriteDword(1); // ç©¿åˆºæ–¹å‘
        obj.sq_SendCreatePassiveObjectPacket(24300, 0, 0, 0, 0);
    }
}
```

### æ¡ˆä¾‹2ï¼šBUFFæŠ€èƒ½å®ç°
```nut
// åŸºäºDAFæ•™ç¨‹çš„BUFFæŠ€èƒ½
function onSetState_PowerBuff(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    // åº”ç”¨BUFFæ•ˆæœ
    sq_AppendAppendage(obj, obj, APPENDAGE_POWER_BUFF, true, `power_buff.ap`, true);
    
    obj.sq_AddSetStatePacket(STATE_STAND, STATE_PRIORITY_USER, true);
}
```

---

*æ­¤æ–‡æ¡£åŸºäºDNF NUTè„šæœ¬ç³»ç»Ÿè®¾è®¡ï¼ŒèåˆDAFå­¦é™¢æ•™ç¨‹ç²¾åï¼Œä¸“æ³¨äºAIæ·±åº¦ç†è§£å’Œå®é™…åº”ç”¨*