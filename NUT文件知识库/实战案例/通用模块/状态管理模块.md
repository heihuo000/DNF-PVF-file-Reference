# NUTè„šæœ¬çŠ¶æ€ç®¡ç†çŸ¥è¯†ç‚¹

## æ ¸å¿ƒæ¦‚å¿µ

çŠ¶æ€ç®¡ç†æ˜¯NUTè„šæœ¬ä¸­å¤„ç†è§’è‰²ã€æŠ€èƒ½å’Œå¯¹è±¡çŠ¶æ€å˜åŒ–çš„é‡è¦æœºåˆ¶ã€‚ä¸»è¦åŒ…æ‹¬çŠ¶æ€çš„åˆ›å»ºã€åº”ç”¨ã€æ›´æ–°ã€ç§»é™¤å’Œå†²çªå¤„ç†ã€‚

## åŸºæœ¬åŸç†

### 1. çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ
```
åˆ›å»ºçŠ¶æ€ â†’ åº”ç”¨çŠ¶æ€ â†’ çŠ¶æ€æ›´æ–° â†’ çŠ¶æ€ç»“æŸ â†’ æ¸…ç†èµ„æº
```

### 2. çŠ¶æ€æ•°æ®ç»“æ„
NUTè„šæœ¬ä¸­çŠ¶æ€é€šå¸¸é€šè¿‡ä»¥ä¸‹æ–¹å¼ç®¡ç†ï¼š
- ä½¿ç”¨`setData`/`getData`å­˜å‚¨çŠ¶æ€ä¿¡æ¯
- é€šè¿‡æ—¶é—´æˆ³è®°å½•çŠ¶æ€å¼€å§‹æ—¶é—´
- ä½¿ç”¨æ ‡å¿—ä½æ ‡è®°çŠ¶æ€ç±»å‹

### 3. çŠ¶æ€åˆ†ç±»
- **BUFFçŠ¶æ€**: å¢ç›Šæ•ˆæœï¼Œå¦‚æ”»å‡»åŠ›æå‡
- **DEBUFFçŠ¶æ€**: å‡ç›Šæ•ˆæœï¼Œå¦‚ç§»åŠ¨é€Ÿåº¦é™ä½  
- **ç‰¹æ®ŠçŠ¶æ€**: æ§åˆ¶æ•ˆæœï¼Œå¦‚çœ©æ™•ã€å†°å†»

## ğŸ”§ æ ¸å¿ƒå®ç°

### çŠ¶æ€ç®¡ç†ä¸»æ¨¡å— (state_manager.nut)

```nut
// =====================================
// çŠ¶æ€ç®¡ç†æ¨¡å— - æ ¸å¿ƒå®ç°
// ä½œè€…ï¼šNUTè„šæœ¬æ•™ç¨‹
// ç‰ˆæœ¬ï¼š2.0
// =====================================

// çŠ¶æ€ç±»å‹å¸¸é‡
const STATE_TYPE_BUFF = 0;               // å¢ç›ŠçŠ¶æ€
const STATE_TYPE_DEBUFF = 1;             // å‡ç›ŠçŠ¶æ€
const STATE_TYPE_NEUTRAL = 2;            // ä¸­æ€§çŠ¶æ€
const STATE_TYPE_SPECIAL = 3;            // ç‰¹æ®ŠçŠ¶æ€

// çŠ¶æ€å åŠ ç±»å‹
const STACK_TYPE_NONE = 0;               // ä¸å¯å åŠ 
const STACK_TYPE_COUNT = 1;              // å±‚æ•°å åŠ 
const STACK_TYPE_DURATION = 2;           // æŒç»­æ—¶é—´å åŠ 
const STACK_TYPE_BOTH = 3;               // å±‚æ•°å’Œæ—¶é—´éƒ½å åŠ 

// çŠ¶æ€ä¼˜å…ˆçº§
const PRIORITY_LOW = 1;                  // ä½ä¼˜å…ˆçº§
const PRIORITY_NORMAL = 5;               // æ™®é€šä¼˜å…ˆçº§
const PRIORITY_HIGH = 10;                // é«˜ä¼˜å…ˆçº§
const PRIORITY_CRITICAL = 15;           // å…³é”®ä¼˜å…ˆçº§
const PRIORITY_ABSOLUTE = 20;            // ç»å¯¹ä¼˜å…ˆçº§

// çŠ¶æ€ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ
const LIFECYCLE_CREATED = 0;             // å·²åˆ›å»º
const LIFECYCLE_ACTIVE = 1;              // æ¿€æ´»ä¸­
const LIFECYCLE_PAUSED = 2;              // æš‚åœä¸­
const LIFECYCLE_EXPIRED = 3;             // å·²è¿‡æœŸ
const LIFECYCLE_REMOVED = 4;             // å·²ç§»é™¤

// =====================================
// çŠ¶æ€æ•°æ®ç»“æ„
// =====================================
class StateData
{
    constructor(stateId, stateType, duration = -1)
    {
        this.stateId = stateId;              // çŠ¶æ€ID
        this.stateType = stateType;          // çŠ¶æ€ç±»å‹
        this.duration = duration;            // æŒç»­æ—¶é—´(-1ä¸ºæ°¸ä¹…)
        this.remainingTime = duration;       // å‰©ä½™æ—¶é—´
        this.stackType = STACK_TYPE_NONE;    // å åŠ ç±»å‹
        this.stackCount = 1;                 // å åŠ å±‚æ•°
        this.maxStack = 1;                   // æœ€å¤§å åŠ å±‚æ•°
        this.priority = PRIORITY_NORMAL;     // ä¼˜å…ˆçº§
        this.lifecycle = LIFECYCLE_CREATED;  // ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
        this.source = null;                  // çŠ¶æ€æ¥æº
        this.target = null;                  // çŠ¶æ€ç›®æ ‡
        this.data = {};                      // è‡ªå®šä¹‰æ•°æ®
        this.effects = [];                   // çŠ¶æ€æ•ˆæœåˆ—è¡¨
        this.dependencies = [];              // ä¾èµ–å…³ç³»
        this.conflicts = [];                 // å†²çªçŠ¶æ€
        this.callbacks = {};                 // å›è°ƒå‡½æ•°
        this.lastUpdateTime = 0;             // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        this.createTime = 0;                 // åˆ›å»ºæ—¶é—´
        this.isVisible = true;               // æ˜¯å¦å¯è§
        this.canDispel = true;               // æ˜¯å¦å¯é©±æ•£
        this.immuneToDispel = false;         // å…ç–«é©±æ•£
    }
    
    // è®¾ç½®çŠ¶æ€æ•ˆæœ
    function addEffect(effectType, value, operation = "add")
    {
        this.effects.append({
            type = effectType,
            value = value,
            operation = operation
        });
    }
    
    // æ·»åŠ ä¾èµ–å…³ç³»
    function addDependency(dependencyType, stateId, condition = null)
    {
        this.dependencies.append({
            type = dependencyType,
            stateId = stateId,
            condition = condition
        });
    }
    
    // æ·»åŠ å†²çªçŠ¶æ€
    function addConflict(stateId, resolution = "replace")
    {
        this.conflicts.append({
            stateId = stateId,
            resolution = resolution  // "replace", "ignore", "coexist"
        });
    }
    
    // è®¾ç½®å›è°ƒå‡½æ•°
    function setCallback(eventType, callback)
    {
        this.callbacks[eventType] <- callback;
    }
    
    // è·å–è‡ªå®šä¹‰æ•°æ®
    function getData(key, defaultValue = null)
    {
        return (key in this.data) ? this.data[key] : defaultValue;
    }
    
    // è®¾ç½®è‡ªå®šä¹‰æ•°æ®
    function setData(key, value)
    {
        this.data[key] <- value;
    }
}

// =====================================
// çŠ¶æ€ç®¡ç†å™¨ç±»
// =====================================
class StateManager
{
    constructor()
    {
        this.states = {};                    // å½“å‰æ´»è·ƒçŠ¶æ€
        this.stateTemplates = {};            // çŠ¶æ€æ¨¡æ¿
        this.globalEffects = {};             // å…¨å±€æ•ˆæœ
        this.updateInterval = 100;           // æ›´æ–°é—´éš”(æ¯«ç§’)
        this.lastUpdateTime = 0;             // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        this.debugMode = false;              // è°ƒè¯•æ¨¡å¼
        this.eventHandlers = {};             // äº‹ä»¶å¤„ç†å™¨
        
        // åˆå§‹åŒ–å†…ç½®çŠ¶æ€æ¨¡æ¿
        this.initBuiltinStates();
    }
    
    // =====================================
    // åˆå§‹åŒ–å†…ç½®çŠ¶æ€æ¨¡æ¿
    // =====================================
    function initBuiltinStates()
    {
        // åŠ›é‡ç¥ç¦
        this.registerStateTemplate("power_blessing", {
            stateType = STATE_TYPE_BUFF,
            stackType = STACK_TYPE_COUNT,
            maxStack = 5,
            priority = PRIORITY_NORMAL,
            effects = [
                { type = "physical_attack_rate", value = 0.1, operation = "multiply" },
                { type = "magical_attack_rate", value = 0.1, operation = "multiply" }
            ],
            conflicts = ["power_curse"],
            canDispel = true
        });
        
        // æŠ¤ç›¾æœ¯
        this.registerStateTemplate("magic_shield", {
            stateType = STATE_TYPE_BUFF,
            stackType = STACK_TYPE_NONE,
            priority = PRIORITY_HIGH,
            effects = [
                { type = "damage_reduction", value = 0.3, operation = "multiply" }
            ],
            canDispel = false,
            immuneToDispel = true
        });
        
        // ç‡ƒçƒ§
        this.registerStateTemplate("burn", {
            stateType = STATE_TYPE_DEBUFF,
            stackType = STACK_TYPE_COUNT,
            maxStack = 10,
            priority = PRIORITY_NORMAL,
            effects = [
                { type = "damage_over_time", value = 50, operation = "add" }
            ],
            conflicts = ["freeze"],
            canDispel = true
        });
        
        // å†°å†»
        this.registerStateTemplate("freeze", {
            stateType = STATE_TYPE_DEBUFF,
            stackType = STACK_TYPE_NONE,
            priority = PRIORITY_HIGH,
            effects = [
                { type = "move_speed_rate", value = 0, operation = "set" },
                { type = "attack_speed_rate", value = 0, operation = "set" }
            ],
            conflicts = ["burn", "paralyze"],
            canDispel = true
        });
        
        // éº»ç—¹
        this.registerStateTemplate("paralyze", {
            stateType = STATE_TYPE_DEBUFF,
            stackType = STACK_TYPE_DURATION,
            priority = PRIORITY_NORMAL,
            effects = [
                { type = "move_speed_rate", value = -0.5, operation = "multiply" },
                { type = "cast_speed_rate", value = -0.3, operation = "multiply" }
            ],
            conflicts = ["freeze"],
            canDispel = true
        });
    }
    
    // =====================================
    // æ³¨å†ŒçŠ¶æ€æ¨¡æ¿
    // =====================================
    function registerStateTemplate(stateId, template)
    {
        this.stateTemplates[stateId] <- template;
        
        if (this.debugMode)
        {
            print("æ³¨å†ŒçŠ¶æ€æ¨¡æ¿: " + stateId);
        }
    }
    
    // =====================================
    // åº”ç”¨çŠ¶æ€åˆ°ç›®æ ‡
    // =====================================
    function applyState(target, stateId, source = null, duration = -1, customData = {})
    {
        if (!target || !(stateId in this.stateTemplates))
        {
            if (this.debugMode)
            {
                print("åº”ç”¨çŠ¶æ€å¤±è´¥: ç›®æ ‡æˆ–çŠ¶æ€æ¨¡æ¿ä¸å­˜åœ¨");
            }
            return null;
        }
        
        local template = this.stateTemplates[stateId];
        local targetId = target.getUniqueId();
        
        // æ£€æŸ¥ç›®æ ‡æ˜¯å¦å·²æœ‰æ­¤çŠ¶æ€
        local existingState = this.getState(target, stateId);
        if (existingState)
        {
            return this.handleExistingState(existingState, template, duration, customData);
        }
        
        // æ£€æŸ¥çŠ¶æ€å†²çª
        local conflictResult = this.checkStateConflicts(target, template);
        if (!conflictResult.canApply)
        {
            if (this.debugMode)
            {
                print("çŠ¶æ€å†²çªï¼Œæ— æ³•åº”ç”¨: " + stateId);
            }
            return null;
        }
        
        // åˆ›å»ºæ–°çŠ¶æ€
        local newState = this.createState(target, stateId, template, source, duration, customData);
        if (!newState)
        {
            return null;
        }
        
        // å¤„ç†å†²çªçŠ¶æ€
        this.resolveStateConflicts(target, newState, conflictResult.conflicts);
        
        // æ·»åŠ åˆ°çŠ¶æ€åˆ—è¡¨
        if (!(targetId in this.states))
        {
            this.states[targetId] <- {};
        }
        this.states[targetId][stateId] <- newState;
        
        // æ¿€æ´»çŠ¶æ€
        this.activateState(newState);
        
        // è§¦å‘äº‹ä»¶
        this.triggerEvent("state_applied", { target = target, state = newState });
        
        if (this.debugMode)
        {
            print("æˆåŠŸåº”ç”¨çŠ¶æ€: " + stateId + " åˆ° " + target.getName());
        }
        
        return newState;
    }
    
    // =====================================
    // åˆ›å»ºçŠ¶æ€å®ä¾‹
    // =====================================
    function createState(target, stateId, template, source, duration, customData)
    {
        // ä½¿ç”¨æ¨¡æ¿åˆ›å»ºçŠ¶æ€
        local stateDuration = (duration != -1) ? duration : template.get("duration", -1);
        local state = StateData(stateId, template.stateType, stateDuration);
        
        // è®¾ç½®åŸºæœ¬å±æ€§
        state.source = source;
        state.target = target;
        state.stackType = template.get("stackType", STACK_TYPE_NONE);
        state.maxStack = template.get("maxStack", 1);
        state.priority = template.get("priority", PRIORITY_NORMAL);
        state.canDispel = template.get("canDispel", true);
        state.immuneToDispel = template.get("immuneToDispel", false);
        state.isVisible = template.get("isVisible", true);
        state.createTime = getTimer();
        state.lastUpdateTime = state.createTime;
        
        // æ·»åŠ æ•ˆæœ
        if ("effects" in template)
        {
            foreach (effect in template.effects)
            {
                state.addEffect(effect.type, effect.value, effect.get("operation", "add"));
            }
        }
        
        // æ·»åŠ å†²çªå…³ç³»
        if ("conflicts" in template)
        {
            foreach (conflictId in template.conflicts)
            {
                state.addConflict(conflictId, template.get("conflictResolution", "replace"));
            }
        }
        
        // æ·»åŠ ä¾èµ–å…³ç³»
        if ("dependencies" in template)
        {
            foreach (dependency in template.dependencies)
            {
                state.addDependency(dependency.type, dependency.stateId, dependency.get("condition", null));
            }
        }
        
        // è®¾ç½®è‡ªå®šä¹‰æ•°æ®
        foreach (key, value in customData)
        {
            state.setData(key, value);
        }
        
        // è®¾ç½®å›è°ƒå‡½æ•°
        if ("callbacks" in template)
        {
            foreach (eventType, callback in template.callbacks)
            {
                state.setCallback(eventType, callback);
            }
        }
        
        return state;
    }
    
    // =====================================
    // å¤„ç†å·²å­˜åœ¨çš„çŠ¶æ€
    // =====================================
    function handleExistingState(existingState, template, duration, customData)
    {
        switch (existingState.stackType)
        {
            case STACK_TYPE_NONE:
                // ä¸å¯å åŠ ï¼Œåˆ·æ–°æŒç»­æ—¶é—´
                if (duration != -1)
                {
                    existingState.remainingTime = duration;
                }
                break;
                
            case STACK_TYPE_COUNT:
                // å±‚æ•°å åŠ 
                if (existingState.stackCount < existingState.maxStack)
                {
                    existingState.stackCount++;
                    this.updateStateEffects(existingState);
                }
                // åˆ·æ–°æŒç»­æ—¶é—´
                if (duration != -1)
                {
                    existingState.remainingTime = duration;
                }
                break;
                
            case STACK_TYPE_DURATION:
                // æŒç»­æ—¶é—´å åŠ 
                if (duration != -1)
                {
                    existingState.remainingTime += duration;
                }
                break;
                
            case STACK_TYPE_BOTH:
                // å±‚æ•°å’Œæ—¶é—´éƒ½å åŠ 
                if (existingState.stackCount < existingState.maxStack)
                {
                    existingState.stackCount++;
                    this.updateStateEffects(existingState);
                }
                if (duration != -1)
                {
                    existingState.remainingTime += duration;
                }
                break;
        }
        
        // æ›´æ–°è‡ªå®šä¹‰æ•°æ®
        foreach (key, value in customData)
        {
            existingState.setData(key, value);
        }
        
        // è§¦å‘åˆ·æ–°äº‹ä»¶
        this.triggerStateCallback(existingState, "on_refresh");
        this.triggerEvent("state_refreshed", { state = existingState });
        
        if (this.debugMode)
        {
            print("åˆ·æ–°çŠ¶æ€: " + existingState.stateId + " å±‚æ•°:" + existingState.stackCount);
        }
        
        return existingState;
    }
    
    // =====================================
    // æ£€æŸ¥çŠ¶æ€å†²çª
    // =====================================
    function checkStateConflicts(target, template)
    {
        local result = {
            canApply = true,
            conflicts = []
        };
        
        local targetId = target.getUniqueId();
        if (!(targetId in this.states))
        {
            return result;
        }
        
        local targetStates = this.states[targetId];
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçŠ¶æ€
        if ("conflicts" in template)
        {
            foreach (conflictId in template.conflicts)
            {
                if (conflictId in targetStates)
                {
                    local conflictState = targetStates[conflictId];
                    
                    // æ¯”è¾ƒä¼˜å…ˆçº§
                    if (conflictState.priority > template.get("priority", PRIORITY_NORMAL))
                    {
                        result.canApply = false;
                        break;
                    }
                    else
                    {
                        result.conflicts.append(conflictState);
                    }
                }
            }
        }
        
        return result;
    }
    
    // =====================================
    // è§£å†³çŠ¶æ€å†²çª
    // =====================================
    function resolveStateConflicts(target, newState, conflicts)
    {
        foreach (conflictState in conflicts)
        {
            // æŸ¥æ‰¾å†²çªè§£å†³æ–¹æ¡ˆ
            local resolution = "replace";  // é»˜è®¤æ›¿æ¢
            
            foreach (conflict in newState.conflicts)
            {
                if (conflict.stateId == conflictState.stateId)
                {
                    resolution = conflict.resolution;
                    break;
                }
            }
            
            switch (resolution)
            {
                case "replace":
                    // æ›¿æ¢å†²çªçŠ¶æ€
                    this.removeState(target, conflictState.stateId);
                    break;
                    
                case "ignore":
                    // å¿½ç•¥æ–°çŠ¶æ€ï¼ˆå®é™…ä¸Šä¸ä¼šåˆ°è¿™é‡Œï¼Œå› ä¸ºcanApplyä¼šæ˜¯falseï¼‰
                    break;
                    
                case "coexist":
                    // å…±å­˜ï¼Œä¸åšå¤„ç†
                    break;
            }
        }
    }
    
    // =====================================
    // æ¿€æ´»çŠ¶æ€
    // =====================================
    function activateState(state)
    {
        state.lifecycle = LIFECYCLE_ACTIVE;
        
        // åº”ç”¨çŠ¶æ€æ•ˆæœ
        this.applyStateEffects(state);
        
        // è§¦å‘æ¿€æ´»å›è°ƒ
        this.triggerStateCallback(state, "on_activate");
        
        // åˆ›å»ºçŠ¶æ€AP
        this.createStateAppendage(state);
        
        if (this.debugMode)
        {
            print("æ¿€æ´»çŠ¶æ€: " + state.stateId);
        }
    }
    
    // =====================================
    // åº”ç”¨çŠ¶æ€æ•ˆæœ
    // =====================================
    function applyStateEffects(state)
    {
        local target = state.target;
        
        foreach (effect in state.effects)
        {
            local value = effect.value;
            
            // å¦‚æœæ˜¯å±‚æ•°å åŠ ï¼Œä¹˜ä»¥å±‚æ•°
            if (state.stackType == STACK_TYPE_COUNT || state.stackType == STACK_TYPE_BOTH)
            {
                value *= state.stackCount;
            }
            
            this.applyEffect(target, effect.type, value, effect.operation, state);
        }
    }
    
    // =====================================
    // åº”ç”¨å•ä¸ªæ•ˆæœ
    // =====================================
    function applyEffect(target, effectType, value, operation, state)
    {
        switch (effectType)
        {
            case "physical_attack":
                this.modifyAttribute(target, "PhysicalAttack", value, operation);
                break;
                
            case "physical_attack_rate":
                this.modifyAttribute(target, "PhysicalAttackRate", value, operation);
                break;
                
            case "magical_attack":
                this.modifyAttribute(target, "MagicalAttack", value, operation);
                break;
                
            case "magical_attack_rate":
                this.modifyAttribute(target, "MagicalAttackRate", value, operation);
                break;
                
            case "physical_defense":
                this.modifyAttribute(target, "PhysicalDefense", value, operation);
                break;
                
            case "magical_defense":
                this.modifyAttribute(target, "MagicalDefense", value, operation);
                break;
                
            case "move_speed_rate":
                this.modifyAttribute(target, "MoveSpeedRate", value, operation);
                break;
                
            case "attack_speed_rate":
                this.modifyAttribute(target, "AttackSpeedRate", value, operation);
                break;
                
            case "cast_speed_rate":
                this.modifyAttribute(target, "CastSpeedRate", value, operation);
                break;
                
            case "critical_rate":
                this.modifyAttribute(target, "CriticalRate", value, operation);
                break;
                
            case "critical_damage":
                this.modifyAttribute(target, "CriticalDamage", value, operation);
                break;
                
            case "damage_reduction":
                this.modifyAttribute(target, "DamageReduction", value, operation);
                break;
                
            case "damage_over_time":
                // DOTæ•ˆæœéœ€è¦ç‰¹æ®Šå¤„ç†
                this.applyDamageOverTime(target, value, state);
                break;
                
            case "heal_over_time":
                // HOTæ•ˆæœéœ€è¦ç‰¹æ®Šå¤„ç†
                this.applyHealOverTime(target, value, state);
                break;
                
            default:
                // è‡ªå®šä¹‰æ•ˆæœ
                this.applyCustomEffect(target, effectType, value, operation, state);
                break;
        }
    }
    
    // =====================================
    // ä¿®æ”¹å±æ€§
    // =====================================
    function modifyAttribute(target, attributeName, value, operation)
    {
        local currentValue = target.getData(attributeName) || 0;
        local newValue = currentValue;
        
        switch (operation)
        {
            case "add":
                newValue = currentValue + value;
                break;
                
            case "multiply":
                newValue = currentValue * (1.0 + value);
                break;
                
            case "set":
                newValue = value;
                break;
                
            case "max":
                newValue = max(currentValue, value);
                break;
                
            case "min":
                newValue = min(currentValue, value);
                break;
        }
        
        target.setData(attributeName, newValue);
        
        // åŒæ­¥åˆ°æ¸¸æˆå±æ€§
        this.syncAttributeToGame(target, attributeName, newValue);
    }
    
    // =====================================
    // åŒæ­¥å±æ€§åˆ°æ¸¸æˆ
    // =====================================
    function syncAttributeToGame(target, attributeName, value)
    {
        switch (attributeName)
        {
            case "PhysicalAttackRate":
                target.addPhysicalAttackRate(value - (target.getData("BasePhysicalAttackRate") || 1.0));
                break;
                
            case "MagicalAttackRate":
                target.addMagicalAttackRate(value - (target.getData("BaseMagicalAttackRate") || 1.0));
                break;
                
            case "MoveSpeedRate":
                target.addMoveSpeedRate(value - (target.getData("BaseMoveSpeedRate") || 1.0));
                break;
                
            case "AttackSpeedRate":
                target.addAttackSpeedRate(value - (target.getData("BaseAttackSpeedRate") || 1.0));
                break;
                
            case "CastSpeedRate":
                target.addCastSpeedRate(value - (target.getData("BaseCastSpeedRate") || 1.0));
                break;
                
            // å…¶ä»–å±æ€§çš„åŒæ­¥...
        }
    }
    
    // =====================================
    // åº”ç”¨DOTæ•ˆæœ
    // =====================================
    function applyDamageOverTime(target, damagePerTick, state)
    {
        // åˆ›å»ºDOT AP
        local dotAP = sq_AppendAppendage(target, state.source || target, 
                                        APPENDAGE_DOT, true, 
                                        "character/common/appendage/dot.nut", 
                                        state.remainingTime);
        if (dotAP)
        {
            dotAP.setData("damagePerTick", damagePerTick);
            dotAP.setData("tickInterval", 1000);  // æ¯ç§’ä¸€æ¬¡
            dotAP.setData("sourceState", state.stateId);
        }
    }
    
    // =====================================
    // åº”ç”¨HOTæ•ˆæœ
    // =====================================
    function applyHealOverTime(target, healPerTick, state)
    {
        // åˆ›å»ºHOT AP
        local hotAP = sq_AppendAppendage(target, state.source || target, 
                                        APPENDAGE_HOT, true, 
                                        "character/common/appendage/hot.nut", 
                                        state.remainingTime);
        if (hotAP)
        {
            hotAP.setData("healPerTick", healPerTick);
            hotAP.setData("tickInterval", 1000);  // æ¯ç§’ä¸€æ¬¡
            hotAP.setData("sourceState", state.stateId);
        }
    }
    
    // =====================================
    // åº”ç”¨è‡ªå®šä¹‰æ•ˆæœ
    // =====================================
    function applyCustomEffect(target, effectType, value, operation, state)
    {
        // è§¦å‘è‡ªå®šä¹‰æ•ˆæœäº‹ä»¶
        this.triggerEvent("custom_effect", {
            target = target,
            effectType = effectType,
            value = value,
            operation = operation,
            state = state
        });
        
        // è°ƒç”¨çŠ¶æ€çš„è‡ªå®šä¹‰æ•ˆæœå›è°ƒ
        this.triggerStateCallback(state, "on_custom_effect", {
            effectType = effectType,
            value = value,
            operation = operation
        });
    }
    
    // =====================================
    // åˆ›å»ºçŠ¶æ€AP
    // =====================================
    function createStateAppendage(state)
    {
        local target = state.target;
        local source = state.source || target;
        
        // åˆ›å»ºçŠ¶æ€AP
        local stateAP = sq_AppendAppendage(target, source, 
                                          APPENDAGE_STATE_BASE + state.stateId.hash(), 
                                          true, 
                                          "character/common/appendage/state.nut", 
                                          state.remainingTime);
        if (stateAP)
        {
            stateAP.setData("stateId", state.stateId);
            stateAP.setData("stateManager", this);
            stateAP.setData("stateData", state);
            
            // è®¾ç½®çŠ¶æ€å›¾æ ‡
            if (state.isVisible)
            {
                this.setStateIcon(stateAP, state);
            }
        }
        
        state.setData("appendage", stateAP);
        return stateAP;
    }
    
    // =====================================
    // è®¾ç½®çŠ¶æ€å›¾æ ‡
    // =====================================
    function setStateIcon(appendage, state)
    {
        local iconPath = "character/common/icon/state/" + state.stateId + ".img";
        appendage.setIcon(iconPath);
        
        // è®¾ç½®å›¾æ ‡é¢œè‰²
        switch (state.stateType)
        {
            case STATE_TYPE_BUFF:
                appendage.setIconColor(0, 255, 0, 255);  // ç»¿è‰²
                break;
            case STATE_TYPE_DEBUFF:
                appendage.setIconColor(255, 0, 0, 255);  // çº¢è‰²
                break;
            case STATE_TYPE_NEUTRAL:
                appendage.setIconColor(255, 255, 255, 255);  // ç™½è‰²
                break;
            case STATE_TYPE_SPECIAL:
                appendage.setIconColor(255, 255, 0, 255);  // é»„è‰²
                break;
        }
        
        // æ˜¾ç¤ºå±‚æ•°
        if (state.stackCount > 1)
        {
            appendage.setIconText(state.stackCount.tostring());
        }
    }
    
    // =====================================
    // æ›´æ–°çŠ¶æ€æ•ˆæœ
    // =====================================
    function updateStateEffects(state)
    {
        // é‡æ–°è®¡ç®—å¹¶åº”ç”¨æ•ˆæœ
        this.removeStateEffects(state);
        this.applyStateEffects(state);
        
        // æ›´æ–°APå›¾æ ‡
        local appendage = state.getData("appendage");
        if (appendage)
        {
            this.setStateIcon(appendage, state);
        }
    }
    
    // =====================================
    // ç§»é™¤çŠ¶æ€æ•ˆæœ
    // =====================================
    function removeStateEffects(state)
    {
        local target = state.target;
        
        foreach (effect in state.effects)
        {
            local value = effect.value;
            
            // å¦‚æœæ˜¯å±‚æ•°å åŠ ï¼Œä¹˜ä»¥å±‚æ•°
            if (state.stackType == STACK_TYPE_COUNT || state.stackType == STACK_TYPE_BOTH)
            {
                value *= state.stackCount;
            }
            
            // åå‘åº”ç”¨æ•ˆæœ
            this.removeEffect(target, effect.type, value, effect.operation, state);
        }
    }
    
    // =====================================
    // ç§»é™¤å•ä¸ªæ•ˆæœ
    // =====================================
    function removeEffect(target, effectType, value, operation, state)
    {
        switch (operation)
        {
            case "add":
                this.modifyAttribute(target, effectType, -value, "add");
                break;
                
            case "multiply":
                this.modifyAttribute(target, effectType, 1.0 / (1.0 + value), "multiply");
                break;
                
            case "set":
                // æ¢å¤åˆ°åŸºç¡€å€¼
                local baseValue = target.getData("Base" + effectType) || 0;
                this.modifyAttribute(target, effectType, baseValue, "set");
                break;
        }
    }
    
    // =====================================
    // è·å–çŠ¶æ€
    // =====================================
    function getState(target, stateId)
    {
        local targetId = target.getUniqueId();
        if (targetId in this.states && stateId in this.states[targetId])
        {
            return this.states[targetId][stateId];
        }
        return null;
    }
    
    // =====================================
    // è·å–ç›®æ ‡çš„æ‰€æœ‰çŠ¶æ€
    // =====================================
    function getAllStates(target)
    {
        local targetId = target.getUniqueId();
        if (targetId in this.states)
        {
            return this.states[targetId];
        }
        return {};
    }
    
    // =====================================
    // ç§»é™¤çŠ¶æ€
    // =====================================
    function removeState(target, stateId)
    {
        local state = this.getState(target, stateId);
        if (!state)
        {
            return false;
        }
        
        // è§¦å‘ç§»é™¤å‰å›è°ƒ
        this.triggerStateCallback(state, "on_before_remove");
        
        // ç§»é™¤çŠ¶æ€æ•ˆæœ
        this.removeStateEffects(state);
        
        // ç§»é™¤AP
        local appendage = state.getData("appendage");
        if (appendage)
        {
            target.removeAppendage(appendage.getAppendageId());
        }
        
        // ä»çŠ¶æ€åˆ—è¡¨ä¸­ç§»é™¤
        local targetId = target.getUniqueId();
        if (targetId in this.states && stateId in this.states[targetId])
        {
            delete this.states[targetId][stateId];
            
            // å¦‚æœç›®æ ‡æ²¡æœ‰å…¶ä»–çŠ¶æ€ï¼Œç§»é™¤ç›®æ ‡è®°å½•
            if (this.states[targetId].len() == 0)
            {
                delete this.states[targetId];
            }
        }
        
        // æ›´æ–°ç”Ÿå‘½å‘¨æœŸ
        state.lifecycle = LIFECYCLE_REMOVED;
        
        // è§¦å‘ç§»é™¤åå›è°ƒ
        this.triggerStateCallback(state, "on_remove");
        this.triggerEvent("state_removed", { target = target, state = state });
        
        if (this.debugMode)
        {
            print("ç§»é™¤çŠ¶æ€: " + stateId + " ä» " + target.getName());
        }
        
        return true;
    }
    
    // =====================================
    // é©±æ•£çŠ¶æ€
    // =====================================
    function dispelStates(target, stateType = -1, count = -1)
    {
        local targetStates = this.getAllStates(target);
        local dispelledCount = 0;
        local maxDispel = (count == -1) ? 999 : count;
        
        // æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆä½ä¼˜å…ˆçº§å…ˆé©±æ•£ï¼‰
        local sortedStates = [];
        foreach (stateId, state in targetStates)
        {
            if (state.canDispel && !state.immuneToDispel)
            {
                if (stateType == -1 || state.stateType == stateType)
                {
                    sortedStates.append(state);
                }
            }
        }
        
        // æŒ‰ä¼˜å…ˆçº§æ’åº
        sortedStates.sort(function(a, b) { return a.priority <=> b.priority; });
        
        // é©±æ•£çŠ¶æ€
        foreach (state in sortedStates)
        {
            if (dispelledCount >= maxDispel)
                break;
                
            if (this.removeState(target, state.stateId))
            {
                dispelledCount++;
            }
        }
        
        // è§¦å‘é©±æ•£äº‹ä»¶
        if (dispelledCount > 0)
        {
            this.triggerEvent("states_dispelled", { 
                target = target, 
                count = dispelledCount,
                stateType = stateType
            });
        }
        
        return dispelledCount;
    }
    
    // =====================================
    // æ›´æ–°çŠ¶æ€ç³»ç»Ÿ
    // =====================================
    function update()
    {
        local currentTime = getTimer();
        if (currentTime - this.lastUpdateTime < this.updateInterval)
        {
            return;
        }
        
        this.lastUpdateTime = currentTime;
        
        // æ›´æ–°æ‰€æœ‰çŠ¶æ€
        local expiredStates = [];
        
        foreach (targetId, targetStates in this.states)
        {
            foreach (stateId, state in targetStates)
            {
                // æ›´æ–°æŒç»­æ—¶é—´
                if (state.duration > 0)
                {
                    state.remainingTime -= this.updateInterval;
                    
                    if (state.remainingTime <= 0)
                    {
                        expiredStates.append({ target = state.target, stateId = stateId });
                        continue;
                    }
                }
                
                // è§¦å‘æ›´æ–°å›è°ƒ
                this.triggerStateCallback(state, "on_update", { deltaTime = this.updateInterval });
                
                // æ›´æ–°çŠ¶æ€æ•°æ®
                state.lastUpdateTime = currentTime;
            }
        }
        
        // ç§»é™¤è¿‡æœŸçŠ¶æ€
        foreach (expiredState in expiredStates)
        {
            this.removeState(expiredState.target, expiredState.stateId);
        }
    }
    
    // =====================================
    // è§¦å‘çŠ¶æ€å›è°ƒ
    // =====================================
    function triggerStateCallback(state, eventType, data = {})
    {
        if (eventType in state.callbacks)
        {
            try
            {
                state.callbacks[eventType](state, data);
            }
            catch (e)
            {
                if (this.debugMode)
                {
                    print("çŠ¶æ€å›è°ƒé”™è¯¯: " + eventType + " - " + e);
                }
            }
        }
    }
    
    // =====================================
    // è§¦å‘å…¨å±€äº‹ä»¶
    // =====================================
    function triggerEvent(eventType, data)
    {
        if (eventType in this.eventHandlers)
        {
            foreach (handler in this.eventHandlers[eventType])
            {
                try
                {
                    handler(data);
                }
                catch (e)
                {
                    if (this.debugMode)
                    {
                        print("äº‹ä»¶å¤„ç†å™¨é”™è¯¯: " + eventType + " - " + e);
                    }
                }
            }
        }
    }
    
    // =====================================
    // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    // =====================================
    function registerEventHandler(eventType, handler)
    {
        if (!(eventType in this.eventHandlers))
        {
            this.eventHandlers[eventType] <- [];
        }
        this.eventHandlers[eventType].append(handler);
    }
    
    // =====================================
    // æ¸…ç†ç›®æ ‡çš„æ‰€æœ‰çŠ¶æ€
    // =====================================
    function clearAllStates(target)
    {
        local targetStates = this.getAllStates(target);
        local removedCount = 0;
        
        foreach (stateId, state in targetStates)
        {
            if (this.removeState(target, stateId))
            {
                removedCount++;
            }
        }
        
        if (this.debugMode)
        {
            print("æ¸…ç†ç›®æ ‡æ‰€æœ‰çŠ¶æ€: " + target.getName() + " ç§»é™¤æ•°é‡: " + removedCount);
        }
        
        return removedCount;
    }
    
    // =====================================
    // è·å–çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯
    // =====================================
    function getStateStats(target)
    {
        local targetStates = this.getAllStates(target);
        local stats = {
            totalStates = 0,
            buffCount = 0,
            debuffCount = 0,
            neutralCount = 0,
            specialCount = 0,
            dispellableCount = 0,
            permanentCount = 0
        };
        
        foreach (stateId, state in targetStates)
        {
            stats.totalStates++;
            
            switch (state.stateType)
            {
                case STATE_TYPE_BUFF:
                    stats.buffCount++;
                    break;
                case STATE_TYPE_DEBUFF:
                    stats.debuffCount++;
                    break;
                case STATE_TYPE_NEUTRAL:
                    stats.neutralCount++;
                    break;
                case STATE_TYPE_SPECIAL:
                    stats.specialCount++;
                    break;
            }
            
            if (state.canDispel)
                stats.dispellableCount++;
                
            if (state.duration == -1)
                stats.permanentCount++;
        }
        
        return stats;
    }
}

// =====================================
// å…¨å±€çŠ¶æ€ç®¡ç†å™¨å®ä¾‹
// =====================================
local g_StateManager = StateManager();

// =====================================
// ä¾¿æ·å‡½æ•°
// =====================================

// åº”ç”¨çŠ¶æ€
function applyState(target, stateId, source = null, duration = -1, customData = {})
{
    return g_StateManager.applyState(target, stateId, source, duration, customData);
}

// ç§»é™¤çŠ¶æ€
function removeState(target, stateId)
{
    return g_StateManager.removeState(target, stateId);
}

// è·å–çŠ¶æ€
function getState(target, stateId)
{
    return g_StateManager.getState(target, stateId);
}

// æ£€æŸ¥æ˜¯å¦æœ‰çŠ¶æ€
function hasState(target, stateId)
{
    return g_StateManager.getState(target, stateId) != null;
}

// é©±æ•£çŠ¶æ€
function dispelStates(target, stateType = -1, count = -1)
{
    return g_StateManager.dispelStates(target, stateType, count);
}

// æ¸…ç†æ‰€æœ‰çŠ¶æ€
function clearAllStates(target)
{
    return g_StateManager.clearAllStates(target);
}

// æ›´æ–°çŠ¶æ€ç³»ç»Ÿï¼ˆéœ€è¦åœ¨ä¸»å¾ªç¯ä¸­è°ƒç”¨ï¼‰
function updateStateSystem()
{
    g_StateManager.update();
}
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨
```nut
// åº”ç”¨åŠ›é‡ç¥ç¦BUFF
applyState(player, "power_blessing", caster, 10000);  // 10ç§’

// åº”ç”¨ç‡ƒçƒ§DEBUFF
applyState(enemy, "burn", player, 5000, { damagePerTick = 100 });

// æ£€æŸ¥çŠ¶æ€
if (hasState(player, "power_blessing"))
{
    print("ç©å®¶æœ‰åŠ›é‡ç¥ç¦çŠ¶æ€");
}

// ç§»é™¤çŠ¶æ€
removeState(player, "power_blessing");

// é©±æ•£æ‰€æœ‰DEBUFF
dispelStates(player, STATE_TYPE_DEBUFF);
```

### é«˜çº§ä½¿ç”¨
```nut
// æ³¨å†Œè‡ªå®šä¹‰çŠ¶æ€æ¨¡æ¿
g_StateManager.registerStateTemplate("custom_buff", {
    stateType = STATE_TYPE_BUFF,
    stackType = STACK_TYPE_COUNT,
    maxStack = 3,
    priority = PRIORITY_HIGH,
    effects = [
        { type = "physical_attack_rate", value = 0.2, operation = "multiply" }
    ],
    callbacks = {
        on_activate = function(state, data) {
            print("è‡ªå®šä¹‰BUFFæ¿€æ´»");
        },
        on_remove = function(state, data) {
            print("è‡ªå®šä¹‰BUFFç§»é™¤");
        }
    }
});

// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
g_StateManager.registerEventHandler("state_applied", function(data) {
    print("çŠ¶æ€åº”ç”¨: " + data.state.stateId);
});

// åœ¨ä¸»å¾ªç¯ä¸­æ›´æ–°çŠ¶æ€ç³»ç»Ÿ
function onUpdate()
{
    updateStateSystem();
}
```

## ğŸ” å¸¸è§é—®é¢˜

### Q1: çŠ¶æ€æ•ˆæœä¸ç”Ÿæ•ˆï¼Ÿ
**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- çŠ¶æ€æ¨¡æ¿æ˜¯å¦æ­£ç¡®æ³¨å†Œ
- æ•ˆæœç±»å‹å’Œæ“ä½œæ˜¯å¦æ­£ç¡®
- å±æ€§åŒæ­¥æ˜¯å¦æ­£å¸¸

### Q2: çŠ¶æ€å†²çªå¤„ç†å¼‚å¸¸ï¼Ÿ
**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- å†²çªå…³ç³»æ˜¯å¦æ­£ç¡®é…ç½®
- ä¼˜å…ˆçº§è®¾ç½®æ˜¯å¦åˆç†
- å†²çªè§£å†³æ–¹æ¡ˆæ˜¯å¦æ­£ç¡®

### Q3: çŠ¶æ€æŒç»­æ—¶é—´å¼‚å¸¸ï¼Ÿ
**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
- æ›´æ–°é—´éš”è®¾ç½®æ˜¯å¦åˆç†
- æ—¶é—´è®¡ç®—æ˜¯å¦æ­£ç¡®
- å åŠ ç±»å‹æ˜¯å¦æ­£ç¡®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [BUFFæŠ€èƒ½.md](../å®æˆ˜æ¡ˆä¾‹/å…¥é—¨çº§/BUFFæŠ€èƒ½.md) - çŠ¶æ€ç®¡ç†çš„å®é™…åº”ç”¨
- [ä¼¤å®³è®¡ç®—æ¨¡å—.md](./ä¼¤å®³è®¡ç®—æ¨¡å—.md) - çŠ¶æ€å¯¹ä¼¤å®³çš„å½±å“
- [æ ‡ç­¾å‚è€ƒ.md](../æ ‡ç­¾å‚è€ƒ.md) - ç›¸å…³å‡½æ•°è¯¦ç»†è¯´æ˜

---

*çŠ¶æ€ç®¡ç†æ¨¡å—æ˜¯æ¸¸æˆç³»ç»Ÿçš„æ ¸å¿ƒï¼Œé€šè¿‡åˆç†çš„è®¾è®¡å¯ä»¥å®ç°å¤æ‚çš„æ¸¸æˆæœºåˆ¶ã€‚å»ºè®®æ ¹æ®å…·ä½“éœ€æ±‚è°ƒæ•´çŠ¶æ€æ¨¡æ¿å’Œæ•ˆæœè®¡ç®—ã€‚*