# NUT脚本状态管理知识点

## 核心概念

状态管理是NUT脚本中处理角色、技能和对象状态变化的重要机制。主要包括状态的创建、应用、更新、移除和冲突处理。

## 基本原理

### 1. 状态生命周期
```
创建状态 → 应用状态 → 状态更新 → 状态结束 → 清理资源
```

### 2. 状态数据结构
NUT脚本中状态通常通过以下方式管理：
- 使用`setData`/`getData`存储状态信息
- 通过时间戳记录状态开始时间
- 使用标志位标记状态类型

### 3. 状态分类
- **BUFF状态**: 增益效果，如攻击力提升
- **DEBUFF状态**: 减益效果，如移动速度降低  
- **特殊状态**: 控制效果，如眩晕、冰冻

## 🔧 核心实现

### 状态管理主模块 (state_manager.nut)

```nut
// =====================================
// 状态管理模块 - 核心实现
// 作者：NUT脚本教程
// 版本：2.0
// =====================================

// 状态类型常量
const STATE_TYPE_BUFF = 0;               // 增益状态
const STATE_TYPE_DEBUFF = 1;             // 减益状态
const STATE_TYPE_NEUTRAL = 2;            // 中性状态
const STATE_TYPE_SPECIAL = 3;            // 特殊状态

// 状态叠加类型
const STACK_TYPE_NONE = 0;               // 不可叠加
const STACK_TYPE_COUNT = 1;              // 层数叠加
const STACK_TYPE_DURATION = 2;           // 持续时间叠加
const STACK_TYPE_BOTH = 3;               // 层数和时间都叠加

// 状态优先级
const PRIORITY_LOW = 1;                  // 低优先级
const PRIORITY_NORMAL = 5;               // 普通优先级
const PRIORITY_HIGH = 10;                // 高优先级
const PRIORITY_CRITICAL = 15;           // 关键优先级
const PRIORITY_ABSOLUTE = 20;            // 绝对优先级

// 状态生命周期阶段
const LIFECYCLE_CREATED = 0;             // 已创建
const LIFECYCLE_ACTIVE = 1;              // 激活中
const LIFECYCLE_PAUSED = 2;              // 暂停中
const LIFECYCLE_EXPIRED = 3;             // 已过期
const LIFECYCLE_REMOVED = 4;             // 已移除

// =====================================
// 状态数据结构
// =====================================
class StateData
{
    constructor(stateId, stateType, duration = -1)
    {
        this.stateId = stateId;              // 状态ID
        this.stateType = stateType;          // 状态类型
        this.duration = duration;            // 持续时间(-1为永久)
        this.remainingTime = duration;       // 剩余时间
        this.stackType = STACK_TYPE_NONE;    // 叠加类型
        this.stackCount = 1;                 // 叠加层数
        this.maxStack = 1;                   // 最大叠加层数
        this.priority = PRIORITY_NORMAL;     // 优先级
        this.lifecycle = LIFECYCLE_CREATED;  // 生命周期状态
        this.source = null;                  // 状态来源
        this.target = null;                  // 状态目标
        this.data = {};                      // 自定义数据
        this.effects = [];                   // 状态效果列表
        this.dependencies = [];              // 依赖关系
        this.conflicts = [];                 // 冲突状态
        this.callbacks = {};                 // 回调函数
        this.lastUpdateTime = 0;             // 上次更新时间
        this.createTime = 0;                 // 创建时间
        this.isVisible = true;               // 是否可见
        this.canDispel = true;               // 是否可驱散
        this.immuneToDispel = false;         // 免疫驱散
    }
    
    // 设置状态效果
    function addEffect(effectType, value, operation = "add")
    {
        this.effects.append({
            type = effectType,
            value = value,
            operation = operation
        });
    }
    
    // 添加依赖关系
    function addDependency(dependencyType, stateId, condition = null)
    {
        this.dependencies.append({
            type = dependencyType,
            stateId = stateId,
            condition = condition
        });
    }
    
    // 添加冲突状态
    function addConflict(stateId, resolution = "replace")
    {
        this.conflicts.append({
            stateId = stateId,
            resolution = resolution  // "replace", "ignore", "coexist"
        });
    }
    
    // 设置回调函数
    function setCallback(eventType, callback)
    {
        this.callbacks[eventType] <- callback;
    }
    
    // 获取自定义数据
    function getData(key, defaultValue = null)
    {
        return (key in this.data) ? this.data[key] : defaultValue;
    }
    
    // 设置自定义数据
    function setData(key, value)
    {
        this.data[key] <- value;
    }
}

// =====================================
// 状态管理器类
// =====================================
class StateManager
{
    constructor()
    {
        this.states = {};                    // 当前活跃状态
        this.stateTemplates = {};            // 状态模板
        this.globalEffects = {};             // 全局效果
        this.updateInterval = 100;           // 更新间隔(毫秒)
        this.lastUpdateTime = 0;             // 上次更新时间
        this.debugMode = false;              // 调试模式
        this.eventHandlers = {};             // 事件处理器
        
        // 初始化内置状态模板
        this.initBuiltinStates();
    }
    
    // =====================================
    // 初始化内置状态模板
    // =====================================
    function initBuiltinStates()
    {
        // 力量祝福
        this.registerStateTemplate("power_blessing", {
            stateType = STATE_TYPE_BUFF,
            stackType = STACK_TYPE_COUNT,
            maxStack = 5,
            priority = PRIORITY_NORMAL,
            effects = [
                { type = "physical_attack_rate", value = 0.1, operation = "multiply" },
                { type = "magical_attack_rate", value = 0.1, operation = "multiply" }
            ],
            conflicts = ["power_curse"],
            canDispel = true
        });
        
        // 护盾术
        this.registerStateTemplate("magic_shield", {
            stateType = STATE_TYPE_BUFF,
            stackType = STACK_TYPE_NONE,
            priority = PRIORITY_HIGH,
            effects = [
                { type = "damage_reduction", value = 0.3, operation = "multiply" }
            ],
            canDispel = false,
            immuneToDispel = true
        });
        
        // 燃烧
        this.registerStateTemplate("burn", {
            stateType = STATE_TYPE_DEBUFF,
            stackType = STACK_TYPE_COUNT,
            maxStack = 10,
            priority = PRIORITY_NORMAL,
            effects = [
                { type = "damage_over_time", value = 50, operation = "add" }
            ],
            conflicts = ["freeze"],
            canDispel = true
        });
        
        // 冰冻
        this.registerStateTemplate("freeze", {
            stateType = STATE_TYPE_DEBUFF,
            stackType = STACK_TYPE_NONE,
            priority = PRIORITY_HIGH,
            effects = [
                { type = "move_speed_rate", value = 0, operation = "set" },
                { type = "attack_speed_rate", value = 0, operation = "set" }
            ],
            conflicts = ["burn", "paralyze"],
            canDispel = true
        });
        
        // 麻痹
        this.registerStateTemplate("paralyze", {
            stateType = STATE_TYPE_DEBUFF,
            stackType = STACK_TYPE_DURATION,
            priority = PRIORITY_NORMAL,
            effects = [
                { type = "move_speed_rate", value = -0.5, operation = "multiply" },
                { type = "cast_speed_rate", value = -0.3, operation = "multiply" }
            ],
            conflicts = ["freeze"],
            canDispel = true
        });
    }
    
    // =====================================
    // 注册状态模板
    // =====================================
    function registerStateTemplate(stateId, template)
    {
        this.stateTemplates[stateId] <- template;
        
        if (this.debugMode)
        {
            print("注册状态模板: " + stateId);
        }
    }
    
    // =====================================
    // 应用状态到目标
    // =====================================
    function applyState(target, stateId, source = null, duration = -1, customData = {})
    {
        if (!target || !(stateId in this.stateTemplates))
        {
            if (this.debugMode)
            {
                print("应用状态失败: 目标或状态模板不存在");
            }
            return null;
        }
        
        local template = this.stateTemplates[stateId];
        local targetId = target.getUniqueId();
        
        // 检查目标是否已有此状态
        local existingState = this.getState(target, stateId);
        if (existingState)
        {
            return this.handleExistingState(existingState, template, duration, customData);
        }
        
        // 检查状态冲突
        local conflictResult = this.checkStateConflicts(target, template);
        if (!conflictResult.canApply)
        {
            if (this.debugMode)
            {
                print("状态冲突，无法应用: " + stateId);
            }
            return null;
        }
        
        // 创建新状态
        local newState = this.createState(target, stateId, template, source, duration, customData);
        if (!newState)
        {
            return null;
        }
        
        // 处理冲突状态
        this.resolveStateConflicts(target, newState, conflictResult.conflicts);
        
        // 添加到状态列表
        if (!(targetId in this.states))
        {
            this.states[targetId] <- {};
        }
        this.states[targetId][stateId] <- newState;
        
        // 激活状态
        this.activateState(newState);
        
        // 触发事件
        this.triggerEvent("state_applied", { target = target, state = newState });
        
        if (this.debugMode)
        {
            print("成功应用状态: " + stateId + " 到 " + target.getName());
        }
        
        return newState;
    }
    
    // =====================================
    // 创建状态实例
    // =====================================
    function createState(target, stateId, template, source, duration, customData)
    {
        // 使用模板创建状态
        local stateDuration = (duration != -1) ? duration : template.get("duration", -1);
        local state = StateData(stateId, template.stateType, stateDuration);
        
        // 设置基本属性
        state.source = source;
        state.target = target;
        state.stackType = template.get("stackType", STACK_TYPE_NONE);
        state.maxStack = template.get("maxStack", 1);
        state.priority = template.get("priority", PRIORITY_NORMAL);
        state.canDispel = template.get("canDispel", true);
        state.immuneToDispel = template.get("immuneToDispel", false);
        state.isVisible = template.get("isVisible", true);
        state.createTime = getTimer();
        state.lastUpdateTime = state.createTime;
        
        // 添加效果
        if ("effects" in template)
        {
            foreach (effect in template.effects)
            {
                state.addEffect(effect.type, effect.value, effect.get("operation", "add"));
            }
        }
        
        // 添加冲突关系
        if ("conflicts" in template)
        {
            foreach (conflictId in template.conflicts)
            {
                state.addConflict(conflictId, template.get("conflictResolution", "replace"));
            }
        }
        
        // 添加依赖关系
        if ("dependencies" in template)
        {
            foreach (dependency in template.dependencies)
            {
                state.addDependency(dependency.type, dependency.stateId, dependency.get("condition", null));
            }
        }
        
        // 设置自定义数据
        foreach (key, value in customData)
        {
            state.setData(key, value);
        }
        
        // 设置回调函数
        if ("callbacks" in template)
        {
            foreach (eventType, callback in template.callbacks)
            {
                state.setCallback(eventType, callback);
            }
        }
        
        return state;
    }
    
    // =====================================
    // 处理已存在的状态
    // =====================================
    function handleExistingState(existingState, template, duration, customData)
    {
        switch (existingState.stackType)
        {
            case STACK_TYPE_NONE:
                // 不可叠加，刷新持续时间
                if (duration != -1)
                {
                    existingState.remainingTime = duration;
                }
                break;
                
            case STACK_TYPE_COUNT:
                // 层数叠加
                if (existingState.stackCount < existingState.maxStack)
                {
                    existingState.stackCount++;
                    this.updateStateEffects(existingState);
                }
                // 刷新持续时间
                if (duration != -1)
                {
                    existingState.remainingTime = duration;
                }
                break;
                
            case STACK_TYPE_DURATION:
                // 持续时间叠加
                if (duration != -1)
                {
                    existingState.remainingTime += duration;
                }
                break;
                
            case STACK_TYPE_BOTH:
                // 层数和时间都叠加
                if (existingState.stackCount < existingState.maxStack)
                {
                    existingState.stackCount++;
                    this.updateStateEffects(existingState);
                }
                if (duration != -1)
                {
                    existingState.remainingTime += duration;
                }
                break;
        }
        
        // 更新自定义数据
        foreach (key, value in customData)
        {
            existingState.setData(key, value);
        }
        
        // 触发刷新事件
        this.triggerStateCallback(existingState, "on_refresh");
        this.triggerEvent("state_refreshed", { state = existingState });
        
        if (this.debugMode)
        {
            print("刷新状态: " + existingState.stateId + " 层数:" + existingState.stackCount);
        }
        
        return existingState;
    }
    
    // =====================================
    // 检查状态冲突
    // =====================================
    function checkStateConflicts(target, template)
    {
        local result = {
            canApply = true,
            conflicts = []
        };
        
        local targetId = target.getUniqueId();
        if (!(targetId in this.states))
        {
            return result;
        }
        
        local targetStates = this.states[targetId];
        
        // 检查是否有冲突状态
        if ("conflicts" in template)
        {
            foreach (conflictId in template.conflicts)
            {
                if (conflictId in targetStates)
                {
                    local conflictState = targetStates[conflictId];
                    
                    // 比较优先级
                    if (conflictState.priority > template.get("priority", PRIORITY_NORMAL))
                    {
                        result.canApply = false;
                        break;
                    }
                    else
                    {
                        result.conflicts.append(conflictState);
                    }
                }
            }
        }
        
        return result;
    }
    
    // =====================================
    // 解决状态冲突
    // =====================================
    function resolveStateConflicts(target, newState, conflicts)
    {
        foreach (conflictState in conflicts)
        {
            // 查找冲突解决方案
            local resolution = "replace";  // 默认替换
            
            foreach (conflict in newState.conflicts)
            {
                if (conflict.stateId == conflictState.stateId)
                {
                    resolution = conflict.resolution;
                    break;
                }
            }
            
            switch (resolution)
            {
                case "replace":
                    // 替换冲突状态
                    this.removeState(target, conflictState.stateId);
                    break;
                    
                case "ignore":
                    // 忽略新状态（实际上不会到这里，因为canApply会是false）
                    break;
                    
                case "coexist":
                    // 共存，不做处理
                    break;
            }
        }
    }
    
    // =====================================
    // 激活状态
    // =====================================
    function activateState(state)
    {
        state.lifecycle = LIFECYCLE_ACTIVE;
        
        // 应用状态效果
        this.applyStateEffects(state);
        
        // 触发激活回调
        this.triggerStateCallback(state, "on_activate");
        
        // 创建状态AP
        this.createStateAppendage(state);
        
        if (this.debugMode)
        {
            print("激活状态: " + state.stateId);
        }
    }
    
    // =====================================
    // 应用状态效果
    // =====================================
    function applyStateEffects(state)
    {
        local target = state.target;
        
        foreach (effect in state.effects)
        {
            local value = effect.value;
            
            // 如果是层数叠加，乘以层数
            if (state.stackType == STACK_TYPE_COUNT || state.stackType == STACK_TYPE_BOTH)
            {
                value *= state.stackCount;
            }
            
            this.applyEffect(target, effect.type, value, effect.operation, state);
        }
    }
    
    // =====================================
    // 应用单个效果
    // =====================================
    function applyEffect(target, effectType, value, operation, state)
    {
        switch (effectType)
        {
            case "physical_attack":
                this.modifyAttribute(target, "PhysicalAttack", value, operation);
                break;
                
            case "physical_attack_rate":
                this.modifyAttribute(target, "PhysicalAttackRate", value, operation);
                break;
                
            case "magical_attack":
                this.modifyAttribute(target, "MagicalAttack", value, operation);
                break;
                
            case "magical_attack_rate":
                this.modifyAttribute(target, "MagicalAttackRate", value, operation);
                break;
                
            case "physical_defense":
                this.modifyAttribute(target, "PhysicalDefense", value, operation);
                break;
                
            case "magical_defense":
                this.modifyAttribute(target, "MagicalDefense", value, operation);
                break;
                
            case "move_speed_rate":
                this.modifyAttribute(target, "MoveSpeedRate", value, operation);
                break;
                
            case "attack_speed_rate":
                this.modifyAttribute(target, "AttackSpeedRate", value, operation);
                break;
                
            case "cast_speed_rate":
                this.modifyAttribute(target, "CastSpeedRate", value, operation);
                break;
                
            case "critical_rate":
                this.modifyAttribute(target, "CriticalRate", value, operation);
                break;
                
            case "critical_damage":
                this.modifyAttribute(target, "CriticalDamage", value, operation);
                break;
                
            case "damage_reduction":
                this.modifyAttribute(target, "DamageReduction", value, operation);
                break;
                
            case "damage_over_time":
                // DOT效果需要特殊处理
                this.applyDamageOverTime(target, value, state);
                break;
                
            case "heal_over_time":
                // HOT效果需要特殊处理
                this.applyHealOverTime(target, value, state);
                break;
                
            default:
                // 自定义效果
                this.applyCustomEffect(target, effectType, value, operation, state);
                break;
        }
    }
    
    // =====================================
    // 修改属性
    // =====================================
    function modifyAttribute(target, attributeName, value, operation)
    {
        local currentValue = target.getData(attributeName) || 0;
        local newValue = currentValue;
        
        switch (operation)
        {
            case "add":
                newValue = currentValue + value;
                break;
                
            case "multiply":
                newValue = currentValue * (1.0 + value);
                break;
                
            case "set":
                newValue = value;
                break;
                
            case "max":
                newValue = max(currentValue, value);
                break;
                
            case "min":
                newValue = min(currentValue, value);
                break;
        }
        
        target.setData(attributeName, newValue);
        
        // 同步到游戏属性
        this.syncAttributeToGame(target, attributeName, newValue);
    }
    
    // =====================================
    // 同步属性到游戏
    // =====================================
    function syncAttributeToGame(target, attributeName, value)
    {
        switch (attributeName)
        {
            case "PhysicalAttackRate":
                target.addPhysicalAttackRate(value - (target.getData("BasePhysicalAttackRate") || 1.0));
                break;
                
            case "MagicalAttackRate":
                target.addMagicalAttackRate(value - (target.getData("BaseMagicalAttackRate") || 1.0));
                break;
                
            case "MoveSpeedRate":
                target.addMoveSpeedRate(value - (target.getData("BaseMoveSpeedRate") || 1.0));
                break;
                
            case "AttackSpeedRate":
                target.addAttackSpeedRate(value - (target.getData("BaseAttackSpeedRate") || 1.0));
                break;
                
            case "CastSpeedRate":
                target.addCastSpeedRate(value - (target.getData("BaseCastSpeedRate") || 1.0));
                break;
                
            // 其他属性的同步...
        }
    }
    
    // =====================================
    // 应用DOT效果
    // =====================================
    function applyDamageOverTime(target, damagePerTick, state)
    {
        // 创建DOT AP
        local dotAP = sq_AppendAppendage(target, state.source || target, 
                                        APPENDAGE_DOT, true, 
                                        "character/common/appendage/dot.nut", 
                                        state.remainingTime);
        if (dotAP)
        {
            dotAP.setData("damagePerTick", damagePerTick);
            dotAP.setData("tickInterval", 1000);  // 每秒一次
            dotAP.setData("sourceState", state.stateId);
        }
    }
    
    // =====================================
    // 应用HOT效果
    // =====================================
    function applyHealOverTime(target, healPerTick, state)
    {
        // 创建HOT AP
        local hotAP = sq_AppendAppendage(target, state.source || target, 
                                        APPENDAGE_HOT, true, 
                                        "character/common/appendage/hot.nut", 
                                        state.remainingTime);
        if (hotAP)
        {
            hotAP.setData("healPerTick", healPerTick);
            hotAP.setData("tickInterval", 1000);  // 每秒一次
            hotAP.setData("sourceState", state.stateId);
        }
    }
    
    // =====================================
    // 应用自定义效果
    // =====================================
    function applyCustomEffect(target, effectType, value, operation, state)
    {
        // 触发自定义效果事件
        this.triggerEvent("custom_effect", {
            target = target,
            effectType = effectType,
            value = value,
            operation = operation,
            state = state
        });
        
        // 调用状态的自定义效果回调
        this.triggerStateCallback(state, "on_custom_effect", {
            effectType = effectType,
            value = value,
            operation = operation
        });
    }
    
    // =====================================
    // 创建状态AP
    // =====================================
    function createStateAppendage(state)
    {
        local target = state.target;
        local source = state.source || target;
        
        // 创建状态AP
        local stateAP = sq_AppendAppendage(target, source, 
                                          APPENDAGE_STATE_BASE + state.stateId.hash(), 
                                          true, 
                                          "character/common/appendage/state.nut", 
                                          state.remainingTime);
        if (stateAP)
        {
            stateAP.setData("stateId", state.stateId);
            stateAP.setData("stateManager", this);
            stateAP.setData("stateData", state);
            
            // 设置状态图标
            if (state.isVisible)
            {
                this.setStateIcon(stateAP, state);
            }
        }
        
        state.setData("appendage", stateAP);
        return stateAP;
    }
    
    // =====================================
    // 设置状态图标
    // =====================================
    function setStateIcon(appendage, state)
    {
        local iconPath = "character/common/icon/state/" + state.stateId + ".img";
        appendage.setIcon(iconPath);
        
        // 设置图标颜色
        switch (state.stateType)
        {
            case STATE_TYPE_BUFF:
                appendage.setIconColor(0, 255, 0, 255);  // 绿色
                break;
            case STATE_TYPE_DEBUFF:
                appendage.setIconColor(255, 0, 0, 255);  // 红色
                break;
            case STATE_TYPE_NEUTRAL:
                appendage.setIconColor(255, 255, 255, 255);  // 白色
                break;
            case STATE_TYPE_SPECIAL:
                appendage.setIconColor(255, 255, 0, 255);  // 黄色
                break;
        }
        
        // 显示层数
        if (state.stackCount > 1)
        {
            appendage.setIconText(state.stackCount.tostring());
        }
    }
    
    // =====================================
    // 更新状态效果
    // =====================================
    function updateStateEffects(state)
    {
        // 重新计算并应用效果
        this.removeStateEffects(state);
        this.applyStateEffects(state);
        
        // 更新AP图标
        local appendage = state.getData("appendage");
        if (appendage)
        {
            this.setStateIcon(appendage, state);
        }
    }
    
    // =====================================
    // 移除状态效果
    // =====================================
    function removeStateEffects(state)
    {
        local target = state.target;
        
        foreach (effect in state.effects)
        {
            local value = effect.value;
            
            // 如果是层数叠加，乘以层数
            if (state.stackType == STACK_TYPE_COUNT || state.stackType == STACK_TYPE_BOTH)
            {
                value *= state.stackCount;
            }
            
            // 反向应用效果
            this.removeEffect(target, effect.type, value, effect.operation, state);
        }
    }
    
    // =====================================
    // 移除单个效果
    // =====================================
    function removeEffect(target, effectType, value, operation, state)
    {
        switch (operation)
        {
            case "add":
                this.modifyAttribute(target, effectType, -value, "add");
                break;
                
            case "multiply":
                this.modifyAttribute(target, effectType, 1.0 / (1.0 + value), "multiply");
                break;
                
            case "set":
                // 恢复到基础值
                local baseValue = target.getData("Base" + effectType) || 0;
                this.modifyAttribute(target, effectType, baseValue, "set");
                break;
        }
    }
    
    // =====================================
    // 获取状态
    // =====================================
    function getState(target, stateId)
    {
        local targetId = target.getUniqueId();
        if (targetId in this.states && stateId in this.states[targetId])
        {
            return this.states[targetId][stateId];
        }
        return null;
    }
    
    // =====================================
    // 获取目标的所有状态
    // =====================================
    function getAllStates(target)
    {
        local targetId = target.getUniqueId();
        if (targetId in this.states)
        {
            return this.states[targetId];
        }
        return {};
    }
    
    // =====================================
    // 移除状态
    // =====================================
    function removeState(target, stateId)
    {
        local state = this.getState(target, stateId);
        if (!state)
        {
            return false;
        }
        
        // 触发移除前回调
        this.triggerStateCallback(state, "on_before_remove");
        
        // 移除状态效果
        this.removeStateEffects(state);
        
        // 移除AP
        local appendage = state.getData("appendage");
        if (appendage)
        {
            target.removeAppendage(appendage.getAppendageId());
        }
        
        // 从状态列表中移除
        local targetId = target.getUniqueId();
        if (targetId in this.states && stateId in this.states[targetId])
        {
            delete this.states[targetId][stateId];
            
            // 如果目标没有其他状态，移除目标记录
            if (this.states[targetId].len() == 0)
            {
                delete this.states[targetId];
            }
        }
        
        // 更新生命周期
        state.lifecycle = LIFECYCLE_REMOVED;
        
        // 触发移除后回调
        this.triggerStateCallback(state, "on_remove");
        this.triggerEvent("state_removed", { target = target, state = state });
        
        if (this.debugMode)
        {
            print("移除状态: " + stateId + " 从 " + target.getName());
        }
        
        return true;
    }
    
    // =====================================
    // 驱散状态
    // =====================================
    function dispelStates(target, stateType = -1, count = -1)
    {
        local targetStates = this.getAllStates(target);
        local dispelledCount = 0;
        local maxDispel = (count == -1) ? 999 : count;
        
        // 按优先级排序（低优先级先驱散）
        local sortedStates = [];
        foreach (stateId, state in targetStates)
        {
            if (state.canDispel && !state.immuneToDispel)
            {
                if (stateType == -1 || state.stateType == stateType)
                {
                    sortedStates.append(state);
                }
            }
        }
        
        // 按优先级排序
        sortedStates.sort(function(a, b) { return a.priority <=> b.priority; });
        
        // 驱散状态
        foreach (state in sortedStates)
        {
            if (dispelledCount >= maxDispel)
                break;
                
            if (this.removeState(target, state.stateId))
            {
                dispelledCount++;
            }
        }
        
        // 触发驱散事件
        if (dispelledCount > 0)
        {
            this.triggerEvent("states_dispelled", { 
                target = target, 
                count = dispelledCount,
                stateType = stateType
            });
        }
        
        return dispelledCount;
    }
    
    // =====================================
    // 更新状态系统
    // =====================================
    function update()
    {
        local currentTime = getTimer();
        if (currentTime - this.lastUpdateTime < this.updateInterval)
        {
            return;
        }
        
        this.lastUpdateTime = currentTime;
        
        // 更新所有状态
        local expiredStates = [];
        
        foreach (targetId, targetStates in this.states)
        {
            foreach (stateId, state in targetStates)
            {
                // 更新持续时间
                if (state.duration > 0)
                {
                    state.remainingTime -= this.updateInterval;
                    
                    if (state.remainingTime <= 0)
                    {
                        expiredStates.append({ target = state.target, stateId = stateId });
                        continue;
                    }
                }
                
                // 触发更新回调
                this.triggerStateCallback(state, "on_update", { deltaTime = this.updateInterval });
                
                // 更新状态数据
                state.lastUpdateTime = currentTime;
            }
        }
        
        // 移除过期状态
        foreach (expiredState in expiredStates)
        {
            this.removeState(expiredState.target, expiredState.stateId);
        }
    }
    
    // =====================================
    // 触发状态回调
    // =====================================
    function triggerStateCallback(state, eventType, data = {})
    {
        if (eventType in state.callbacks)
        {
            try
            {
                state.callbacks[eventType](state, data);
            }
            catch (e)
            {
                if (this.debugMode)
                {
                    print("状态回调错误: " + eventType + " - " + e);
                }
            }
        }
    }
    
    // =====================================
    // 触发全局事件
    // =====================================
    function triggerEvent(eventType, data)
    {
        if (eventType in this.eventHandlers)
        {
            foreach (handler in this.eventHandlers[eventType])
            {
                try
                {
                    handler(data);
                }
                catch (e)
                {
                    if (this.debugMode)
                    {
                        print("事件处理器错误: " + eventType + " - " + e);
                    }
                }
            }
        }
    }
    
    // =====================================
    // 注册事件处理器
    // =====================================
    function registerEventHandler(eventType, handler)
    {
        if (!(eventType in this.eventHandlers))
        {
            this.eventHandlers[eventType] <- [];
        }
        this.eventHandlers[eventType].append(handler);
    }
    
    // =====================================
    // 清理目标的所有状态
    // =====================================
    function clearAllStates(target)
    {
        local targetStates = this.getAllStates(target);
        local removedCount = 0;
        
        foreach (stateId, state in targetStates)
        {
            if (this.removeState(target, stateId))
            {
                removedCount++;
            }
        }
        
        if (this.debugMode)
        {
            print("清理目标所有状态: " + target.getName() + " 移除数量: " + removedCount);
        }
        
        return removedCount;
    }
    
    // =====================================
    // 获取状态统计信息
    // =====================================
    function getStateStats(target)
    {
        local targetStates = this.getAllStates(target);
        local stats = {
            totalStates = 0,
            buffCount = 0,
            debuffCount = 0,
            neutralCount = 0,
            specialCount = 0,
            dispellableCount = 0,
            permanentCount = 0
        };
        
        foreach (stateId, state in targetStates)
        {
            stats.totalStates++;
            
            switch (state.stateType)
            {
                case STATE_TYPE_BUFF:
                    stats.buffCount++;
                    break;
                case STATE_TYPE_DEBUFF:
                    stats.debuffCount++;
                    break;
                case STATE_TYPE_NEUTRAL:
                    stats.neutralCount++;
                    break;
                case STATE_TYPE_SPECIAL:
                    stats.specialCount++;
                    break;
            }
            
            if (state.canDispel)
                stats.dispellableCount++;
                
            if (state.duration == -1)
                stats.permanentCount++;
        }
        
        return stats;
    }
}

// =====================================
// 全局状态管理器实例
// =====================================
local g_StateManager = StateManager();

// =====================================
// 便捷函数
// =====================================

// 应用状态
function applyState(target, stateId, source = null, duration = -1, customData = {})
{
    return g_StateManager.applyState(target, stateId, source, duration, customData);
}

// 移除状态
function removeState(target, stateId)
{
    return g_StateManager.removeState(target, stateId);
}

// 获取状态
function getState(target, stateId)
{
    return g_StateManager.getState(target, stateId);
}

// 检查是否有状态
function hasState(target, stateId)
{
    return g_StateManager.getState(target, stateId) != null;
}

// 驱散状态
function dispelStates(target, stateType = -1, count = -1)
{
    return g_StateManager.dispelStates(target, stateType, count);
}

// 清理所有状态
function clearAllStates(target)
{
    return g_StateManager.clearAllStates(target);
}

// 更新状态系统（需要在主循环中调用）
function updateStateSystem()
{
    g_StateManager.update();
}
```

## 📝 使用示例

### 基础使用
```nut
// 应用力量祝福BUFF
applyState(player, "power_blessing", caster, 10000);  // 10秒

// 应用燃烧DEBUFF
applyState(enemy, "burn", player, 5000, { damagePerTick = 100 });

// 检查状态
if (hasState(player, "power_blessing"))
{
    print("玩家有力量祝福状态");
}

// 移除状态
removeState(player, "power_blessing");

// 驱散所有DEBUFF
dispelStates(player, STATE_TYPE_DEBUFF);
```

### 高级使用
```nut
// 注册自定义状态模板
g_StateManager.registerStateTemplate("custom_buff", {
    stateType = STATE_TYPE_BUFF,
    stackType = STACK_TYPE_COUNT,
    maxStack = 3,
    priority = PRIORITY_HIGH,
    effects = [
        { type = "physical_attack_rate", value = 0.2, operation = "multiply" }
    ],
    callbacks = {
        on_activate = function(state, data) {
            print("自定义BUFF激活");
        },
        on_remove = function(state, data) {
            print("自定义BUFF移除");
        }
    }
});

// 注册事件处理器
g_StateManager.registerEventHandler("state_applied", function(data) {
    print("状态应用: " + data.state.stateId);
});

// 在主循环中更新状态系统
function onUpdate()
{
    updateStateSystem();
}
```

## 🔍 常见问题

### Q1: 状态效果不生效？
**A:** 检查以下几点：
- 状态模板是否正确注册
- 效果类型和操作是否正确
- 属性同步是否正常

### Q2: 状态冲突处理异常？
**A:** 检查以下几点：
- 冲突关系是否正确配置
- 优先级设置是否合理
- 冲突解决方案是否正确

### Q3: 状态持续时间异常？
**A:** 检查以下几点：
- 更新间隔设置是否合理
- 时间计算是否正确
- 叠加类型是否正确

## 📚 相关文档

- [BUFF技能.md](../实战案例/入门级/BUFF技能.md) - 状态管理的实际应用
- [伤害计算模块.md](./伤害计算模块.md) - 状态对伤害的影响
- [标签参考.md](../标签参考.md) - 相关函数详细说明

---

*状态管理模块是游戏系统的核心，通过合理的设计可以实现复杂的游戏机制。建议根据具体需求调整状态模板和效果计算。*