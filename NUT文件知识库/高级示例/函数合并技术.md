# å‡½æ•°åˆå¹¶æŠ€æœ¯è¯¦è§£

åŸºäºDAFå­¦é™¢æ•™ç¨‹çš„NUTè„šæœ¬å‡½æ•°åˆå¹¶æ–¹æ³•ï¼Œè§£å†³å¤šMODå†²çªé—®é¢˜ã€‚

## ğŸ¯ é—®é¢˜èƒŒæ™¯

å½“å¤šä¸ªMODä½¿ç”¨ç›¸åŒçš„å›è°ƒå‡½æ•°æ—¶ï¼ŒååŠ è½½çš„MODä¼šè¦†ç›–å…ˆåŠ è½½çš„MODçš„å‡½æ•°ï¼Œå¯¼è‡´åŠŸèƒ½å†²çªã€‚å‡½æ•°åˆå¹¶æŠ€æœ¯å¯ä»¥å°†å¤šä¸ªMODçš„åŠŸèƒ½æ•´åˆåˆ°ä¸€ä¸ªå‡½æ•°ä¸­ã€‚

## ğŸ” å†²çªè¯†åˆ«

### å¸¸è§å†²çªå‡½æ•°
```nut
// è§’è‰²å›è°ƒå‡½æ•°
drawMainCustomUI_Swordman()     // ä¸»ç•Œé¢UIç»˜åˆ¶
drawCustomUI_Swordman()         // è‡ªå®šä¹‰UIç»˜åˆ¶
onStartDungeon_Swordman()       // è¿›å…¥åœ°ä¸‹åŸ
onStartMap_Swordman()           // è¿›å…¥åœ°å›¾
procAppend_Swordman()           // è§’è‰²å¤„ç†å‡½æ•°
onAttack_Swordman()             // æ”»å‡»å›è°ƒ

// æŠ€èƒ½å›è°ƒå‡½æ•°
onSetState_SkillName()          // æŠ€èƒ½çŠ¶æ€è®¾ç½®
onKeyFrameFlag_SkillName()      // å…³é”®å¸§äº‹ä»¶
onAttack_SkillName()            // æŠ€èƒ½æ”»å‡»åˆ¤å®š
```

### å†²çªç¤ºä¾‹
```nut
// MOD A - è¡€æ¡æ˜¾ç¤º
function drawCustomUI_Swordman(obj)
{
    if(!obj) return;
    drawBloodBar(obj);
}

// MOD B - æŠ€èƒ½å†·å´æ˜¾ç¤ºï¼ˆä¼šè¦†ç›–MOD Aï¼‰
function drawCustomUI_Swordman(obj)
{
    if(!obj) return;
    drawSkillCooldown(obj);
}

// ç»“æœï¼šåªæœ‰æŠ€èƒ½å†·å´æ˜¾ç¤ºç”Ÿæ•ˆï¼Œè¡€æ¡æ˜¾ç¤ºå¤±æ•ˆ
```

## ğŸ”§ åˆå¹¶æ–¹æ³•

### 1. åŸºç¡€åˆå¹¶

```nut
// åˆå¹¶åçš„å‡½æ•°
function drawCustomUI_Swordman(obj)
{
    if(!obj) return;
    
    // åˆå¹¶MOD Açš„åŠŸèƒ½
    drawBloodBar(obj);
    
    // åˆå¹¶MOD Bçš„åŠŸèƒ½
    drawSkillCooldown(obj);
    
    // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šMODçš„åŠŸèƒ½
    drawBuffIcons(obj);
    drawDamageCounter(obj);
}
```

### 2. æ¡ä»¶åˆå¹¶

```nut
// å¸¦æ¡ä»¶åˆ¤æ–­çš„åˆå¹¶
function onStartDungeon_Swordman(obj)
{
    if(!obj) return;
    
    // MOD Aï¼šç‰¹å®šåœ°ä¸‹åŸçš„åŠŸèƒ½
    local dungeonId = obj.sq_GetCurrentDungeonId();
    if(dungeonId == 1001 || dungeonId == 1002)
    {
        initSpecialDungeonFeatures(obj);
    }
    
    // MOD Bï¼šé€šç”¨åŠŸèƒ½
    initCommonFeatures(obj);
    
    // MOD Cï¼šèŒä¸šç‰¹å®šåŠŸèƒ½
    local job = obj.sq_GetJob();
    if(job == JOB_SWORDMAN)
    {
        initSwordmanFeatures(obj);
    }
}
```

### 3. ä¼˜å…ˆçº§åˆå¹¶

```nut
// æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œçš„åˆå¹¶
function procAppend_Swordman(obj)
{
    if(!obj) return;
    
    // é«˜ä¼˜å…ˆçº§ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰
    coreProcessing(obj);
    
    // ä¸­ä¼˜å…ˆçº§ï¼šå¢å¼ºåŠŸèƒ½
    try
    {
        enhancedProcessing(obj);
    }
    catch(error)
    {
        print(`[WARNING] å¢å¼ºåŠŸèƒ½æ‰§è¡Œå¤±è´¥: ` + error);
    }
    
    // ä½ä¼˜å…ˆçº§ï¼šå¯é€‰åŠŸèƒ½
    try
    {
        optionalProcessing(obj);
    }
    catch(error)
    {
        print(`[INFO] å¯é€‰åŠŸèƒ½è·³è¿‡: ` + error);
    }
}
```

## ğŸš€ é«˜çº§åˆå¹¶æŠ€æœ¯

### 1. æ¨¡å—åŒ–åˆå¹¶

```nut
// å®šä¹‰æ¨¡å—æ¥å£
MODULE_REGISTRY <- {}

// æ³¨å†Œæ¨¡å—
function registerModule(name, moduleFunc)
{
    MODULE_REGISTRY[name] <- moduleFunc;
}

// æ‰§è¡Œæ‰€æœ‰æ¨¡å—
function executeAllModules(obj, functionName)
{
    foreach(name, moduleFunc in MODULE_REGISTRY)
    {
        try
        {
            moduleFunc(obj, functionName);
        }
        catch(error)
        {
            print(`[ERROR] æ¨¡å— ` + name + ` æ‰§è¡Œå¤±è´¥: ` + error);
        }
    }
}

// æ³¨å†Œå„ä¸ªMODçš„æ¨¡å—
registerModule(`BloodBarMod`, function(obj, funcName) {
    if(funcName == `drawCustomUI` && obj)
        drawBloodBar(obj);
});

registerModule(`SkillCooldownMod`, function(obj, funcName) {
    if(funcName == `drawCustomUI` && obj)
        drawSkillCooldown(obj);
});

// ç»Ÿä¸€çš„å›è°ƒå‡½æ•°
function drawCustomUI_Swordman(obj)
{
    executeAllModules(obj, `drawCustomUI`);
}
```

### 2. äº‹ä»¶é©±åŠ¨åˆå¹¶

```nut
// äº‹ä»¶ç³»ç»Ÿ
EVENT_HANDLERS <- {}

// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
function addEventListener(eventName, handler)
{
    if(!(eventName in EVENT_HANDLERS))
        EVENT_HANDLERS[eventName] <- [];
    
    EVENT_HANDLERS[eventName].append(handler);
}

// è§¦å‘äº‹ä»¶
function triggerEvent(eventName, obj, data = null)
{
    if(eventName in EVENT_HANDLERS)
    {
        foreach(handler in EVENT_HANDLERS[eventName])
        {
            try
            {
                handler(obj, data);
            }
            catch(error)
            {
                print(`[ERROR] äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå¤±è´¥: ` + error);
            }
        }
    }
}

// æ³¨å†Œå„ç§äº‹ä»¶å¤„ç†å™¨
addEventListener(`onDungeonStart`, function(obj, data) {
    initBloodBarSystem(obj);
});

addEventListener(`onDungeonStart`, function(obj, data) {
    initSkillCooldownSystem(obj);
});

addEventListener(`onDungeonStart`, function(obj, data) {
    initBuffSystem(obj);
});

// ç»Ÿä¸€çš„å›è°ƒå‡½æ•°
function onStartDungeon_Swordman(obj)
{
    triggerEvent(`onDungeonStart`, obj);
}
```

### 3. é…ç½®é©±åŠ¨åˆå¹¶

```nut
// åŠŸèƒ½é…ç½®è¡¨
FEATURE_CONFIG <- {
    bloodBar = {
        enabled = true,
        priority = 1,
        func = drawBloodBar
    },
    skillCooldown = {
        enabled = true,
        priority = 2,
        func = drawSkillCooldown
    },
    buffIcons = {
        enabled = false,  // å¯ä»¥é€šè¿‡é…ç½®ç¦ç”¨
        priority = 3,
        func = drawBuffIcons
    }
}

// æŒ‰é…ç½®æ‰§è¡ŒåŠŸèƒ½
function executeConfiguredFeatures(obj, featureType)
{
    // è·å–å¯ç”¨çš„åŠŸèƒ½å¹¶æŒ‰ä¼˜å…ˆçº§æ’åº
    local enabledFeatures = [];
    foreach(name, config in FEATURE_CONFIG)
    {
        if(config.enabled)
        {
            enabledFeatures.append({
                name = name,
                priority = config.priority,
                func = config.func
            });
        }
    }
    
    // æŒ‰ä¼˜å…ˆçº§æ’åº
    enabledFeatures.sort(function(a, b) {
        return a.priority <=> b.priority;
    });
    
    // æ‰§è¡ŒåŠŸèƒ½
    foreach(feature in enabledFeatures)
    {
        try
        {
            feature.func(obj);
        }
        catch(error)
        {
            print(`[ERROR] åŠŸèƒ½ ` + feature.name + ` æ‰§è¡Œå¤±è´¥: ` + error);
        }
    }
}

// ç»Ÿä¸€çš„å›è°ƒå‡½æ•°
function drawCustomUI_Swordman(obj)
{
    executeConfiguredFeatures(obj, `ui`);
}
```

## ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šæŠ€èƒ½çŠ¶æ€åˆå¹¶

```nut
// å¤šä¸ªMODä¿®æ”¹åŒä¸€ä¸ªæŠ€èƒ½çš„çŠ¶æ€è®¾ç½®
function onSetState_Slash(obj, state, datas, isResetTimer)
{
    if(!obj) return;
    
    // åŸç‰ˆåŠŸèƒ½
    obj.sq_SetCurrentAnimation(ANIMATION_SLASH);
    obj.sq_StopMove();
    
    // MOD Aï¼šæ·»åŠ ç‰¹æ•ˆ
    if(hasModA())
    {
        obj.sq_StartWrite();
        obj.sq_WriteDword(1001);  // ç‰¹æ•ˆID
        obj.sq_SendCreatePassiveObjectPacket(24100, 0, 0, 0, 0);
    }
    
    // MOD Bï¼šä¿®æ”¹ä¼¤å®³
    if(hasModB())
    {
        local damage = obj.sq_GetIntData(SKILL_SLASH, SKL_BASIC_DAMAGE);
        damage = damage * 1.5;  // å¢åŠ 50%ä¼¤å®³
        obj.sq_SetDamage(damage);
    }
    
    // MOD Cï¼šæ·»åŠ BUFF
    if(hasModC())
    {
        sq_AppendAppendage(obj, obj, APPENDAGE_SLASH_BUFF, true, `slash_buff.ap`, true);
    }
}

// MODæ£€æµ‹å‡½æ•°
function hasModA() { return true; }  // æ ¹æ®å®é™…æƒ…å†µå®ç°
function hasModB() { return true; }
function hasModC() { return true; }
```

### æ¡ˆä¾‹2ï¼šæ”»å‡»åˆ¤å®šåˆå¹¶

```nut
// å¤šä¸ªMODä¿®æ”¹æ”»å‡»åˆ¤å®š
function onAttack_Swordman(obj, damager, boundingBox, isStuck)
{
    if(!obj || !damager) return;
    
    // åŸç‰ˆæ”»å‡»å¤„ç†
    local damage = damager.sq_GetDamage();
    local attackType = damager.sq_GetAttackType();
    
    // MOD Aï¼šæš´å‡»ç³»ç»Ÿ
    if(hasModA())
    {
        local critChance = obj.sq_GetBonusRateWithPassive(CRITICAL_HIT);
        if(sq_Rand(0, 100) < critChance)
        {
            damage = damage * 2;  // æš´å‡»ä¼¤å®³
            // æ˜¾ç¤ºæš´å‡»ç‰¹æ•ˆ
            obj.sq_StartWrite();
            obj.sq_WriteDword(2001);  // æš´å‡»ç‰¹æ•ˆID
            obj.sq_SendCreatePassiveObjectPacket(24200, 0, 0, 0, 0);
        }
    }
    
    // MOD Bï¼šå…ƒç´ ä¼¤å®³
    if(hasModB())
    {
        local elementType = getWeaponElement(obj);
        if(elementType != ELEMENT_NONE)
        {
            local elementDamage = damage * 0.3;  // 30%å…ƒç´ ä¼¤å®³
            damager.sq_SetElementalDamage(elementType, elementDamage);
        }
    }
    
    // MOD Cï¼šè¿å‡»ç³»ç»Ÿ
    if(hasModC())
    {
        incrementComboCounter(obj);
        local comboBonus = getComboBonus(obj);
        damage = damage * comboBonus;
    }
    
    // åº”ç”¨æœ€ç»ˆä¼¤å®³
    damager.sq_SetDamage(damage);
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ‰§è¡Œé¡ºåº
- æŸäº›åŠŸèƒ½å¯¹æ‰§è¡Œé¡ºåºæ•æ„Ÿ
- ä½¿ç”¨ä¼˜å…ˆçº§ç³»ç»Ÿæ§åˆ¶æ‰§è¡Œé¡ºåº
- æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆï¼Œè£…é¥°åŠŸèƒ½å…¶æ¬¡

### 2. é”™è¯¯éš”ç¦»
```nut
function safeExecuteFunction(func, obj, errorMessage)
{
    try
    {
        func(obj);
    }
    catch(error)
    {
        print(`[ERROR] ` + errorMessage + `: ` + error);
        // ä¸å½±å“å…¶ä»–åŠŸèƒ½çš„æ‰§è¡Œ
    }
}
```

### 3. æ€§èƒ½è€ƒè™‘
- é¿å…åœ¨é«˜é¢‘å›è°ƒä¸­æ‰§è¡Œå¤æ‚é€»è¾‘
- ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„åŠŸèƒ½

### 4. å…¼å®¹æ€§æ£€æŸ¥
```nut
function checkModCompatibility()
{
    local conflicts = [];
    
    // æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
    if(getModVersion(`ModA`) < 2.0 && getModVersion(`ModB`) > 3.0)
    {
        conflicts.append(`ModAç‰ˆæœ¬è¿‡ä½ï¼Œä¸ModBä¸å…¼å®¹`);
    }
    
    // æ£€æŸ¥åŠŸèƒ½å†²çª
    if(hasFeature(`CustomUI`) && hasFeature(`AlternativeUI`))
    {
        conflicts.append(`UIåŠŸèƒ½å†²çª`);
    }
    
    return conflicts;
}
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ–‡æ¡£åŒ–**: è¯¦ç»†è®°å½•æ¯ä¸ªMODçš„åŠŸèƒ½å’Œä¾èµ–
2. **æ¨¡å—åŒ–**: å°†åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹çš„æ¨¡å—
3. **é…ç½®åŒ–**: æä¾›å¼€å…³æ§åˆ¶å„ä¸ªåŠŸèƒ½
4. **æµ‹è¯•**: å……åˆ†æµ‹è¯•åˆå¹¶åçš„åŠŸèƒ½
5. **å‘åå…¼å®¹**: ä¿æŒä¸åŸç‰ˆåŠŸèƒ½çš„å…¼å®¹æ€§

## ğŸ“ åˆå¹¶å·¥ä½œæµ

1. **åˆ†æå†²çª** â†’ è¯†åˆ«å†²çªçš„å‡½æ•°å’ŒåŠŸèƒ½
2. **è®¾è®¡æ¶æ„** â†’ é€‰æ‹©åˆé€‚çš„åˆå¹¶æ–¹æ¡ˆ
3. **å®ç°åˆå¹¶** â†’ ç¼–å†™åˆå¹¶åçš„å‡½æ•°
4. **æµ‹è¯•éªŒè¯** â†’ ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
5. **ä¼˜åŒ–æ€§èƒ½** â†’ ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡å’Œç¨³å®šæ€§

---

*åŸºäºDAFå­¦é™¢æ•™ç¨‹æ•´ç†ï¼Œä¸“æ³¨äºè§£å†³NUTè„šæœ¬çš„MODå†²çªé—®é¢˜*