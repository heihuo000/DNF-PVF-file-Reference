# 墓碑脱手+阵法跟随模组集成方案

## 1. 模组概述

### 功能特性
- **墓碑脱手**：允许墓碑雨技能脱手投掷
- **阵法跟随**：鬼泣阵法跟随角色移动
- **御鬼极意**：新的被动技能，增强鬼泣技能并提供特殊效果

### 文件结构
```
墓碑脱手+阵法跟随/
├── skill/swordman/phantommastery.skl          # 御鬼极意技能文件
├── passiveobject/elesc/bladespirit_skill.obj  # 脱手墓碑被动对象
├── passiveobject/elesc/attackinfo/tombstone.atk # 墓碑攻击信息
└── sqr/character/swordman/0_elesc/bladespirit/bladespirit_skill.nut # 脱手逻辑脚本
```

## 2. 冲突分析

### 技能名称冲突
- **问题**：模组的`phantommastery.skl`与现有`ghostrelease.skl`都名为"御鬼之极"
- **解决方案**：将模组技能重命名为"御鬼极意"以区分功能

### 状态ID使用
- **模组使用状态**：44（蓄力）、45（投掷）
- **现有系统**：状态44在`swordman_header.nut`中已定义为墓碑雨相关
- **状态兼容性**：需要验证状态44/45是否与现有墓碑雨冲突

### 被动对象ID
- **模组使用ID**：243445
- **需要验证**：确保该ID未被其他被动对象使用

## 3. 集成步骤

### 第一阶段：文件准备
1. **技能文件集成**
   ```
   目标位置：skill/swordman/phantommastery.skl
   修改内容：技能名称改为"御鬼极意"
   ```

2. **被动对象集成**
   ```
   目标位置：passiveobject/elesc/bladespirit_skill.obj
   目标位置：passiveobject/elesc/attackinfo/tombstone.atk
   ```

3. **脚本文件集成**
   ```
   目标位置：sqr/character/swordman/bladespirit_skill.nut
   集成方式：独立文件，避免与现有脚本冲突
   ```

### 第二阶段：脚本集成
1. **状态处理集成**
   - 在`swordman_common.nut`中添加对状态44/45的处理
   - 确保与现有墓碑雨技能兼容

2. **技能列表更新**
   - 将`phantommastery.skl`添加到`skill/swordmanskill.lst`
   - 确保技能ID不冲突

### 第三阶段：兼容性处理
1. **状态冲突解决**
   - 如果状态44/45冲突，分配新的状态ID
   - 更新脚本中的状态引用

2. **被动对象ID验证**
   - 检查243445是否被占用
   - 如有冲突，分配新ID并更新引用

## 4. 技术实现细节

### 脚本函数映射
```nut
// 模组新增函数
function onSetState_BladeSpirit(obj, state, datas, isResetTimer)
function onEndState_BladeSpirit(obj, new_state)  
function onEndCurrentAni_BladeSpirit(obj)

// 集成到现有系统
function setState_Swordman(obj, state, datas, isResetTimer) {
    // 现有逻辑...
    
    // 添加模组状态处理
    if (state == 44 || state == 45) {
        onSetState_BladeSpirit(obj, state, datas, isResetTimer);
    }
}
```

### 状态处理逻辑
- **状态44**：墓碑雨蓄力，播放动画，设置施法时间
- **状态45**：墓碑投掷，创建被动对象243445，设置超级护甲

### 被动对象创建
```nut
obj.sq_SendCreatePassiveObjectPacket(243445, 0, 0, -1, 0);
```

## 5. 测试验证

### 功能测试
1. **墓碑脱手测试**
   - 验证墓碑雨可以脱手投掷
   - 确认投掷后墓碑正常爆炸

2. **阵法跟随测试**
   - 验证鬼泣阵法跟随角色移动
   - 确认阵法效果正常

3. **技能效果测试**
   - 验证御鬼极意技能正常学习和升级
   - 确认技能效果符合描述

### 兼容性测试
1. **与现有技能兼容性**
   - 确保不影响其他剑魂技能
   - 验证技能连招正常

2. **PVP兼容性**
   - 测试PVP环境下功能正常
   - 确保无异常崩溃

## 6. 风险评估

### 高风险项
- 状态ID冲突可能导致技能异常
- 被动对象ID冲突可能导致游戏崩溃

### 中风险项  
- 脚本集成可能影响现有技能逻辑
- 技能名称冲突可能导致混淆

### 低风险项
- 文件路径冲突（已确认无冲突）
- 动画文件兼容性

## 7. 回滚方案

### 快速回滚
1. 删除新增的技能文件
2. 恢复原始技能列表
3. 删除新增的脚本文件

### 完整回滚
1. 使用备份恢复所有修改的文件
2. 重新打包PVF文件
3. 验证游戏正常运行

## 8. 实施时间表

1. **准备阶段**（10分钟）：文件检查和备份
2. **集成阶段**（20分钟）：文件复制和修改
3. **测试阶段**（15分钟）：功能验证
4. **优化阶段**（10分钟）：问题修复

总计预估时间：55分钟