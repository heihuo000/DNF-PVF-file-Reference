# DNF技能修改操作手册

## 目录
- [概述](#概述)
- [准备工作](#准备工作)
- [技能文件结构详解](#技能文件结构详解)
- [技能修改步骤](#技能修改步骤)
- [常见错误与调试](#常见错误与调试)
- [实战案例](#实战案例)
- [注意事项](#注意事项)
- [参考资源](#参考资源)

## 概述

本手册详细介绍如何在DNF中添加和修改技能，包括技能文件的结构分析、修改步骤、常见错误处理等内容。通过本手册，您将能够安全、高效地进行技能修改工作。

## 准备工作

### 必备工具
1. **[PVF MCP工具](README.md#pvf-mcp工具)** - 用于PVF文件管理、分析和验证
2. **文本编辑器** - 推荐使用VS Code或Notepad++
3. **[格式检查工具](格式规范工具/PVF格式检查增强版.py)** - 检查文件格式规范
4. **备份工具** - 确保原始文件安全（建议使用版本控制系统）

### 环境配置

#### 1. 文件备份
```
重要提醒：修改前必须备份原始PVF文件！
```
- 复制原始PVF文件到安全位置
- 建议创建版本控制文件夹
- 记录每次修改的内容和时间

#### 2. 编辑器设置
**VS Code配置**：
```json
{
    "files.encoding": "utf8",
    "files.eol": "\r\n",
    "editor.insertSpaces": false,
    "editor.tabSize": 4,
    "editor.detectIndentation": false
}
```

**Notepad++配置**：
- 编码：UTF-8
- 行尾符：Windows (CRLF)
- 缩进：Tab键，4个字符宽度

#### 3. 工作目录结构
```
工作目录/
├── 原始文件/
│   └── Script.pvf (备份)
├── 修改文件/
│   └── Script.pvf (工作版本)
├── 临时文件/
│   ├── 解包文件/
│   └── 测试文件/
└── 文档/
    ├── 修改记录.txt
    └── 技能列表.txt
```

### 技能系统基础知识

#### 技能文件类型
1. **SKL文件** - 技能定义文件，包含技能属性、等级信息等
2. **NUT文件** - 技能脚本文件，控制技能逻辑和行为
3. **ANI文件** - 动画文件，定义技能动作
4. **ATK文件** - 攻击判定文件

#### 技能组成要素
- **基础属性**：名称、描述、图标、指令
- **学习条件**：等级要求、前置技能、SP消耗
- **技能数据**：MP消耗、冷却时间、伤害数值
- **行为逻辑**：NUT脚本控制的技能行为

## 技能文件结构详解

### SKL文件结构

#### 基本信息段
```
[name] `技能名称`
[explain] `技能说明`
[basic explain] `基础说明`
[purchase cost] 购买SP消耗
[required level] 学习等级
[required skill] 前置技能ID 前置技能等级
[type] 技能类型 (0=被动, 1=主动)
[skill class] 技能分类
[maximum level] 最大等级
[growtype maximum level] 成长类型最大等级
[durability decrease rate] 耐久度降低率
[weapon effect type] 武器效果类型 (0=物理, 1=魔法)
[icon] 图标路径
[command] 指令
```

#### 消耗与冷却段
```
[dungeon]
	[level]
		1	MP消耗	冷却时间(毫秒)
		2	MP消耗	冷却时间(毫秒)
		...
	[/level]
[/dungeon]

[pvp]
	[level]
		1	MP消耗	冷却时间(毫秒)
		2	MP消耗	冷却时间(毫秒)
		...
	[/level]
[/pvp]
```

#### 静态数据段
```
[static data]
	数值1 数值2 数值3 ... // 不随等级变化的固定数值
[/static data]
```

#### 等级信息段
```
[level info]
	数据组数量 数值1 数值2 数值3 ... // 第一级数据
	数据组数量 数值1 数值2 数值3 ... // 第二级数据
	...
[/level info]
```

#### 等级属性段
```
[level property]
	1	`等级1描述 : <float1>数值单位`	-1 0 0.001000
	2	`等级2描述 : <float2>数值单位`	-1 1 0.001000
	...
[/level property]
```

### 数据解读方法

#### static data与level info的关系
- **static data**：静态数据，所有等级共用
- **level info**：动态数据，每级不同
- **数据编号**：从0开始计数

#### 属性描述解读
格式：`描述文本 : <float编号>单位`
对应数据：`数据来源标识 数据编号 倍率`

**数据来源标识**：
- 负数（如-1）：来自level info
- 非负数（如6,8）：来自static data

**示例解读**：
```
持续时间 : <float1>秒
对应数据：-1 13 0.001000

解读过程：
1. -1表示数据来自level info
2. 13表示level info中编号为13的数据
3. 0.001000是倍率
4. 最终值 = level info[13] × 0.001000
```

## 技能修改步骤

### 步骤1：技能定位与分析

#### 1.1 确定目标技能
- 明确要修改的技能名称和所属职业
- 查找对应的SKL文件路径
- 确认技能ID和相关文件

#### 1.2 文件定位
```
技能文件路径规律：
skill/[职业名]/[技能文件名].skl

常见职业名：
- swordman (鬼剑士)
- gunner (神枪手男)
- atgunner (神枪手女)
- fighter (格斗家女)
- atfighter (格斗家男)
- mage (魔法师女)
- atmage (魔法师男)
- priest (圣职者)
- thief (暗夜使者)
```

#### 1.3 相关文件分析
- 检查是否有对应的NUT脚本文件
- 确认动画文件和攻击判定文件
- 分析技能树配置文件

### 步骤2：解包与编辑

#### 2.1 PVF文件解包
1. 使用PVF编辑器打开Script.pvf
2. 定位到目标技能文件
3. 解包到工作目录
4. 验证文件完整性

#### 2.2 文件编辑
1. 使用配置好的文本编辑器打开SKL文件
2. 按照格式规范进行修改
3. 保存文件（确保编码为UTF-8，行尾为CRLF）

#### 2.3 修改验证
- 检查语法格式是否正确
- 验证数值范围是否合理
- 确认引用关系是否正确

### 步骤3：技能树配置

#### 3.1 技能树文件定位
```
技能树文件路径：
clientonly/skilltree/[职业]_sp.co

例如：
- swordman_sp.co (鬼剑士)
- priest_sp.co (圣职者)
- gunner_sp.co (神枪手男)
```

#### 3.2 添加技能到技能树
```
技能树条目格式：
技能ID	坐标X 坐标Y	前置技能ID1:等级1,前置技能ID2:等级2

示例：
101	47 0	1:1,2:5
```

#### 3.3 坐标计算
- 技能图标大小：通常为32x32像素
- 坐标原点：左上角为(0,0)
- 间距建议：水平40像素，垂直40像素

### 步骤4：脚本编写（如需要）

#### 4.1 NUT脚本基础结构
```nut
// 技能检查函数
function checkExecutableSkill_技能名(obj)
{
    // 检查MP、冷却时间等条件
    return true;
}

// 状态设置函数
function onSetState_技能名(obj, state, datas, isResetTimer)
{
    // 初始化技能状态
}

// 时间事件函数
function onTimeEvent_技能名(obj, timeEventIndex, datas)
{
    // 处理技能时序逻辑
}

// 攻击函数
function onAttack_技能名(obj, damager, boundingBox, isStuck)
{
    // 处理攻击逻辑和伤害计算
}

// 结束函数
function onEndState_技能名(obj, new_state)
{
    // 清理和重置
}
```

#### 4.2 常用脚本模板
参考现有技能的NUT文件，复制相似功能的代码结构进行修改。

### 步骤5：打包与测试

#### 5.1 文件打包
1. 将修改后的文件重新打包到PVF
2. 确保文件路径正确
3. 验证打包完整性

#### 5.2 游戏测试
1. 替换游戏中的PVF文件
2. 启动游戏进行测试
3. 检查技能是否正常显示和运行
4. 测试各种场景下的技能表现

#### 5.3 问题排查
- 如果游戏崩溃，检查文件格式
- 如果技能不显示，检查技能树配置
- 如果技能无效果，检查NUT脚本

## 常见错误与调试

### 格式错误

#### 1. 字符串格式错误
**错误示例**：
```
[name] "血影·鬼切"  // 错误：使用了双引号
```
**正确格式**：
```
[name] `血影·鬼切`  // 正确：使用反引号
```

#### 2. 缩进错误
**错误示例**：
```
[dungeon]
    [level]  // 错误：使用空格缩进
        1    50    3000
    [/level]
[/dungeon]
```
**正确格式**：
```
[dungeon]
	[level]  // 正确：使用Tab缩进
		1	50	3000
	[/level]
[/dungeon]
```

#### 3. 数值格式错误
**错误示例**：
```
[required level] `15`  // 错误：数值加了引号
[maximum level] 70.0   // 错误：整数写成浮点数
```
**正确格式**：
```
[required level] 15    // 正确：数值直接写
[maximum level] 70     // 正确：整数格式
```

### 逻辑错误

#### 1. 前置技能错误
- 前置技能ID不存在
- 前置技能等级超出范围
- 循环依赖问题

#### 2. 数值范围错误
- MP消耗为负数
- 冷却时间过长或过短
- 伤害数值异常

#### 3. 技能树坐标冲突
- 多个技能使用相同坐标
- 坐标超出技能树范围
- 技能图标重叠

### 调试方法

#### 1. 分步测试
- 先修改基础属性，测试显示
- 再修改数值，测试效果
- 最后添加脚本，测试逻辑

#### 2. 日志分析
- 查看游戏错误日志
- 分析崩溃转储文件
- 使用调试工具

#### 3. 对比验证
- 与原始文件对比
- 参考相似技能的实现
- 使用验证工具检查

## 实战案例

### 案例1：修改鬼斩技能伤害

#### 目标
将鬼斩技能的伤害提升50%

#### 步骤
1. **定位文件**：`skill/swordman/hardattack.skl`
2. **分析数据结构**：
   ```
   [level info]
   14 28 400 72 79 86 57 122 90 14 252 700 200 2000 40000
   ```
3. **确定伤害数据**：通过level property确定伤害对应的数据位置
4. **修改数值**：将对应位置的数值乘以1.5
5. **测试验证**：进入游戏测试伤害变化

### 案例2：添加新技能到技能树

#### 目标
为圣骑士添加召唤师的式神技能

#### 步骤
1. **复制技能文件**：
   ```
   从：skill/mage/shikigami.skl
   到：skill/priest/shikigami.skl
   ```
2. **修改技能属性**：
   ```
   [required level] 1        // 改为1级学习
   [purchase cost] 1         // SP消耗改为1
   [maximum level] 70        // 最高70级
   ```
3. **修改技能树**：
   ```
   在priest_sp.co中添加：
   101	47 0	1:1  // 技能ID 101，坐标(47,0)，前置空斩打1级
   ```
4. **测试功能**：确保技能正常显示和使用

### 案例3：修改技能冷却时间

#### 目标
将某技能的冷却时间从10秒改为5秒

#### 步骤
1. **定位冷却数据**：在dungeon和pvp段中找到冷却时间
2. **计算新数值**：5秒 = 5000毫秒
3. **批量修改**：修改所有等级的冷却时间
4. **验证效果**：测试技能冷却是否正确

## 注意事项

### 安全规范
1. **必须备份**：修改前务必备份原始文件
2. **格式严格**：严格遵守PVF文件格式规范
3. **测试充分**：每次修改后都要进行充分测试
4. **版本控制**：记录每次修改的内容和版本

### 性能考虑
1. **数值合理**：避免设置过大或过小的数值
2. **脚本优化**：NUT脚本要考虑性能影响
3. **兼容性**：确保修改不影响其他功能

### 常见陷阱
1. **编码问题**：文件编码必须是UTF-8
2. **行尾符**：必须使用Windows格式的CRLF
3. **缩进统一**：全部使用Tab键，不要混用空格
4. **引号规范**：字符串必须用反引号，数值不加引号

## 参考资源

### 官方示例文件
- `参考资料/sample(官方注释)/skillsample.skl` - 官方技能示例
- `PVF文件格式规范.md` - 格式规范文档

### 教程资源
- DAF学院技能修改教程系列
- NUT脚本知识总结文档
- 技能数据解读教程

### 工具推荐
- **[PVF MCP工具](README.md#pvf-mcp工具)**：用于PVF文件管理、分析和验证
- **VS Code**：推荐的文本编辑器，支持语法高亮和格式化
- **[格式检查工具](格式规范工具/PVF格式检查增强版.py)**：自动检查和修复格式问题
- **[格式规范工具集](格式规范工具/README.md)**：完整的格式规范工具套件

### 在线资源
- DAF学院论坛技能修改版块
- 相关技术交流群
- 开源项目和代码示例

---

## 总结

技能修改是一个需要细心和耐心的工作，涉及多个文件和复杂的数据结构。通过本手册的指导，您应该能够：

1. 理解技能文件的结构和格式要求
2. 掌握安全的修改流程和方法
3. 识别和解决常见的错误问题
4. 进行有效的测试和调试

记住，成功的技能修改需要：
- **严格的格式规范**
- **充分的测试验证**
- **完整的备份机制**
- **持续的学习改进**

希望本手册能够帮助您顺利完成技能修改工作，创造出更加精彩的游戏体验！

---
*本手册基于86nut版本PVF文件编写，持续更新中...*