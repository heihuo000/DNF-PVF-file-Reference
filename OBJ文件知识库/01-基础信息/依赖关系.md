# OBJ文件依赖关系

## 🔗 依赖关系概述

OBJ文件作为被动对象的定义文件，需要与多种其他文件类型协作才能实现完整的功能。理解这些依赖关系对于正确创建和调试OBJ文件至关重要。

## 📁 核心依赖文件

### ACT文件（动作文件）
**作用**：定义对象的动画序列和时序控制

```obj
[basic action]
`Action/thunder_strike.act`    # 引用ACT文件
```

**ACT文件内容示例**：
```act
#PVF_File

[MOTION]
	[BASE ANI]
		`../Animation/ThunderStrike.ani`    # 引用ANI文件
[/MOTION]
```

**关系说明**：
- OBJ → ACT → ANI 的引用链
- ACT控制动画播放时序
- 支持多个动画状态切换

### ATK文件（攻击文件）
**作用**：定义伤害计算、元素属性和攻击效果

```obj
[attack info]
`AttackInfo/lightning_damage.atk`    # 引用ATK文件
```

**ATK文件内容示例**：
```atk
#PVF_File

[damage bonus]
100                           # 伤害百分比

[attack type]
[magic]                       # 魔法攻击

[weapon damage apply]
1                             # 应用武器伤害

[elemental property]
[light element]               # 光元素属性

[hit wav]
`THUNDER_STRIKE`              # 命中音效
```

### ANI文件（动画文件）
**作用**：提供具体的动画帧和视觉效果

**引用方式**：
- 通过ACT文件间接引用
- 定义动画帧序列
- 包含攻击判定框（ATTACK BOX）

## 🎵 音效依赖

### 音效文件引用
```obj
# 在ATK文件中定义
[hit wav]
`THUNDER_STRIKE`              # 音效标识符

# 或在OBJ中直接引用
[sound]
`Sound/thunder.wav`           # 直接音效文件路径
```

### 音效类型
- **命中音效**：攻击命中时播放
- **创建音效**：对象生成时播放
- **销毁音效**：对象消失时播放
- **环境音效**：持续播放的背景音

## 🖼️ 图像资源依赖

### 贴图文件
```ani
# ANI文件中引用的图像资源
[IMAGE]
`Sprite/effect/thunder.img`   # 图像文件路径
```

### 粒子效果
```obj
[particle]
`Particle/thunder_spark.ptl`  # 粒子效果文件
```

## 📊 数据文件依赖

### LST文件（列表文件）
**作用**：定义对象ID和文件路径的映射关系

```lst
# passiveobject.lst 示例
35881    `passiveobject/thunder_strike.obj`
35882    `passiveobject/fire_ball.obj`
35883    `passiveobject/ice_spike.obj`
```

### 装备文件引用
```equ
# 装备文件中创建被动对象
[if]
	[attack success]
		1
[/if]

[then]
	[target]
		`enemy`    -1
	[probability]
		100
	[passive object]
		35881    0    0    0    99    -1    ``    # 对象ID、坐标、层级等
	[/passive object]
[/then]
```

## 🎯 技能系统依赖

### 技能文件引用
```skl
# 技能文件中创建对象
[create passive object]
	`passiveobject/skill_effect.obj`    # 直接文件路径

# 或通过ID引用
[passive object]
	35881    # 对象ID
```

### 状态效果依赖
```obj
# OBJ可以触发状态效果
[state]
`State/burn.sta`              # 状态文件路径
```

## 🗺️ 地图系统依赖

### 地图文件关联
```map
# 地图文件中预设对象
[passive object]
35881    100    200    0       # ID、X坐标、Y坐标、层级
```

### 环境交互
- **碰撞检测**：与地图碰撞层交互
- **位置约束**：受地图边界限制
- **图层渲染**：按地图图层系统渲染

## 📋 依赖关系图

```
OBJ文件 (被动对象定义)
├── ACT文件 (动作控制)
│   └── ANI文件 (动画资源)
│       ├── IMG文件 (图像贴图)
│       └── ATTACK BOX (攻击判定)
├── ATK文件 (攻击属性)
│   ├── 伤害计算
│   ├── 元素属性
│   └── 音效引用
├── 音效文件
│   ├── WAV文件
│   └── OGG文件
├── 粒子效果
│   └── PTL文件
└── 被引用方
    ├── EQU文件 (装备)
    ├── SKL文件 (技能)
    ├── MAP文件 (地图)
    └── LST文件 (列表)
```

## ⚠️ 依赖管理注意事项

### 文件路径规范
```obj
# ✅ 正确：相对路径
[basic action]
`Action/effect.act`

# ✅ 正确：绝对路径（从PVF根目录）
[basic action]
`passiveobject/Action/effect.act`

# ❌ 错误：Windows路径分隔符
[basic action]
`Action\effect.act`
```

### 文件存在性检查
1. **ACT文件**：确保动作文件存在且格式正确
2. **ATK文件**：验证攻击文件的伤害设置
3. **ANI文件**：检查动画文件和图像资源
4. **音效文件**：确认音效文件可用

### 循环依赖避免
```obj
# ❌ 避免：对象A创建对象B，对象B又创建对象A
# 这会导致无限循环和游戏崩溃
```

## 🔧 依赖调试技巧

### 分层测试
1. **基础测试**：只使用name和layer标签
2. **动画测试**：添加basic action，测试动画
3. **攻击测试**：添加attack info，测试伤害
4. **完整测试**：所有功能综合测试

### 错误排查
```obj
# 常见错误检查清单：
# 1. 文件路径是否正确？
# 2. 引用的文件是否存在？
# 3. 文件格式是否正确？
# 4. 是否有循环依赖？
# 5. 权限设置是否正确？
```

### 工具辅助
- **PVF编辑器**：检查文件引用
- **游戏日志**：查看加载错误
- **调试模式**：逐步验证功能

## 📈 性能优化

### 资源共享
```obj
# 多个OBJ共享相同的ACT/ATK文件
# 减少资源重复加载
[basic action]
`Action/common_effect.act`    # 通用动作文件
```

### 延迟加载
- 按需加载依赖资源
- 避免预加载过多文件
- 合理设置对象生命周期

### 内存管理
- 及时销毁不需要的对象
- 避免创建过多同类对象
- 优化动画和音效资源

---

*下一步：学习 [基础属性标签](../02-标签参考/基础属性标签.md)*