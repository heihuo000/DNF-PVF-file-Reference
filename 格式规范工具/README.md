# PVF格式检查工具使用说明

## 📋 工具概述

PVF格式检查工具是专为DNF PVF文件开发的智能格式规范检查器，能够：

- ✅ **智能检查缩进格式** - 区分空格和制表符的正确使用场景
- ✅ **验证字符串引号** - 确保使用反引号而非双引号或单引号
- ✅ **检查参数分隔** - 验证制表符分隔的正确使用
- ✅ **文件编码检查** - 确保UTF-8编码和CRLF行尾符
- ✅ **结构完整性** - 检查标签配对和文件结构
- ✅ **自动修复功能** - 一键修复大部分格式问题

## 🚀 快速开始

### 基础检查
```bash
# 检查单个文件
python PVF格式检查增强版.py example.equ

# 检查多个文件
python PVF格式检查增强版.py *.equ *.stk *.map
```

### 自动修复
```bash
# 自动修复问题（会创建备份）
python PVF格式检查增强版.py example.equ --auto-fix

# 自动修复且不创建备份
python PVF格式检查增强版.py example.equ --auto-fix --no-backup
```

### 批量处理
```bash
# 批量检查并显示汇总
python PVF格式检查增强版.py *.equ --summary

# 批量自动修复
python PVF格式检查增强版.py *.equ --auto-fix
```

## 📊 检查项目详解

### 1. 缩进格式检查
- **智能识别** - 区分缩进和普通空格使用场景
- **混用检测** - 发现空格和制表符混用问题
- **上下文感知** - 根据代码结构判断是否需要制表符

**示例问题：**
```
❌ 错误：使用空格缩进
    [name] `测试装备`

✅ 正确：使用制表符缩进
	[name] `测试装备`
```

### 2. 字符串引号检查
- **标准引号** - 确保字符串值使用反引号 `` ` ``
- **类型识别** - 根据标签类型智能判断参数类型
- **错误修正** - 自动建议正确的引号格式

**示例问题：**
```
❌ 错误：使用双引号
[name] "血影·鬼切"

✅ 正确：使用反引号
[name] `血影·鬼切`
```

### 3. 参数分隔检查
- **制表符分隔** - 确保标签参数使用制表符分隔
- **空格检测** - 发现错误的空格分隔使用
- **智能修复** - 自动转换为正确的制表符分隔

**示例问题：**
```
❌ 错误：使用空格分隔
[equipment option] 1 2 3

✅ 正确：使用制表符分隔
[equipment option]	1	2	3
```

### 4. 数值格式检查
- **无引号数值** - 确保数值不被错误地加上引号
- **类型验证** - 验证数值格式的正确性
- **混合参数** - 智能处理包含字符串和数值的混合标签

**示例问题：**
```
❌ 错误：数值加引号
[level] `85`

✅ 正确：数值无引号
[level] 85
```

## 🔧 命令行参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `files` | 要检查的文件路径（支持通配符） | `*.equ` |
| `--auto-fix` | 自动修复可修复的问题 | `--auto-fix` |
| `--no-backup` | 自动修复时不创建备份文件 | `--no-backup` |
| `--quiet` | 只显示错误信息 | `--quiet` |
| `--summary` | 显示汇总报告（多文件时） | `--summary` |
| `--json` | 将结果保存为JSON文件 | `--json result.json` |

## 📈 报告解读

### 问题严重程度
- 🔴 **错误 (Error)** - 必须修复，会导致游戏崩溃
- 🟡 **警告 (Warning)** - 建议修复，可能影响功能
- ℹ️ **信息 (Info)** - 可选修复，代码风格问题

### 报告示例
```
📋 PVF格式检查详细报告
==================================================
文件: example.equ
总行数: 45
文件大小: 1024 字节
编码: UTF-8
检查耗时: 0.05s

发现 3 个问题：
  🔴 错误: 2 个 (必须修复)
  🟡 警告: 1 个 (建议修复)
  ℹ️ 信息: 0 个 (可选修复)

🔴 错误详情 (必须修复):
1. 行 15: 标签 [name] 的字符串参数使用双引号，应该使用反引号
   类型: 字符串引号错误
   当前: [name] "血影·鬼切"
   建议: [name] `血影·鬼切`
   规范: PVF格式规范 - 2.字符串值格式
   自动修复: 是
```

## 🛠️ 高级功能

### 1. 批量处理脚本
创建批处理脚本 `check_all.bat`：
```batch
@echo off
echo 正在检查所有PVF文件...
python PVF格式检查增强版.py equipment\*.equ --summary
python PVF格式检查增强版.py stackable\*.stk --summary
python PVF格式检查增强版.py map\*.map --summary
echo 检查完成！
pause
```

### 2. 自动修复脚本
创建自动修复脚本 `auto_fix.bat`：
```batch
@echo off
echo 正在自动修复PVF文件格式问题...
python PVF格式检查增强版.py equipment\*.equ --auto-fix
python PVF格式检查增强版.py stackable\*.stk --auto-fix
echo 修复完成！备份文件已创建。
pause
```

### 3. 集成到编辑器
在VS Code中添加任务配置 `.vscode/tasks.json`：
```json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "PVF格式检查",
            "type": "shell",
            "command": "python",
            "args": [
                "格式规范工具/PVF格式检查增强版.py",
                "${file}"
            ],
            "group": "build",
            "presentation": {
                "echo": true,
                "reveal": "always",
                "focus": false,
                "panel": "shared"
            }
        }
    ]
}
```

## ⚠️ 注意事项

### 1. 备份重要性
- 自动修复前会创建 `.backup` 备份文件
- 建议在修复前手动备份重要文件
- 使用 `--no-backup` 参数需谨慎

### 2. 特殊情况
- 某些特殊值如 `[all]`, `[normal]` 不需要额外引号
- 注释行和空行会被跳过检查
- 文件头 `#PVF_File` 是必需的

### 3. 性能考虑
- 大文件检查可能需要较长时间
- 批量处理时建议使用 `--summary` 参数
- JSON输出适合程序化处理

## 🔍 常见问题

### Q: 工具报告缩进错误，但我觉得格式是对的？
A: 工具会智能判断缩进上下文。如果是标签行或参数行，应该使用制表符而不是空格。

### Q: 自动修复后还有问题怎么办？
A: 某些复杂的结构问题需要手动修复，工具会在报告中标明哪些问题无法自动修复。

### Q: 可以检查整个目录吗？
A: 可以使用通配符，如 `python PVF格式检查增强版.py **/*.equ` 检查所有子目录的equ文件。

### Q: 如何集成到CI/CD流程？
A: 工具返回的退出码表示错误数量，可以在脚本中检查返回值来判断是否通过检查。

## 📚 相关文档

- [PVF文件格式规范](../PVF文件格式规范.md)
- [EQU文件知识库](../EQU文件知识库/)
- [STK文件知识库](../STK文件知识库/)
- [SHO文件知识库](../SHO文件知识库/)

## 🤝 贡献与反馈

如果发现工具有误报或漏报，请：
1. 提供具体的文件示例
2. 说明期望的行为
3. 附上相关的格式规范引用

---

*最后更新: 2024年12月*