# PVF格式转换工具使用说明

## 📖 工具概述

PVF格式转换工具是一个自动化工具，用于修复PVF文件中的常见格式错误，确保文件符合严格的PVF格式规范。

## 🔧 功能特性

### 自动修复的格式问题

1. **引号格式修复**
   - 将双引号 `"` 转换为反引号 `` ` ``
   - 将单引号 `'` 转换为反引号 `` ` ``

2. **缩进格式修复**
   - 将空格缩进转换为TAB缩进
   - 自动计算缩进层级（4个空格 = 1个TAB）

3. **参数分隔修复**
   - 将多个连续空格转换为TAB分隔符
   - 确保参数之间使用TAB分隔

4. **标签格式修复**
   - 移除标签内的多余空格
   - 规范化标签格式 `[tag_name]`

5. **行尾符统一**
   - 统一使用LF（\n）作为行尾符
   - 移除CRLF（\r\n）和CR（\r）

## 📋 使用方法

### 基本用法

```bash
# 转换单个文件（原地修改）
python PVF格式转换工具.py 文件名.equ

# 转换单个文件到新文件
python PVF格式转换工具.py 输入文件.equ 输出文件.equ

# 转换目录中的所有PVF文件
python PVF格式转换工具.py 目录路径

# 递归转换子目录
python PVF格式转换工具.py 目录路径 --recursive

# 创建备份文件
python PVF格式转换工具.py 文件名.equ --backup
```

### 高级选项

```bash
# 预览模式（不实际修改文件）
python PVF格式转换工具.py 文件名.equ --dry-run

# 递归转换并创建备份
python PVF格式转换工具.py 目录路径 -r -b

# 查看帮助信息
python PVF格式转换工具.py --help

# 或使用增强版检查工具
python PVF格式检查增强版.py --help
```

## 📝 使用示例

### 示例1：修复单个文件

```bash
# 原文件内容（错误格式）
[avatar]
    "name" = "哈林狂魄者短发[A款]"
    item/avatar/fighter/ft_ahair.img    640

# 运行转换工具
python PVF格式转换工具.py 402560159.equ

# 转换后内容（正确格式）
[avatar]
	`name`	`哈林狂魄者短发[A款]`
	item/avatar/fighter/ft_ahair.img	640
```

### 示例2：批量转换目录

```bash
# 转换当前目录所有PVF文件
python PVF格式转换工具.py . --backup

# 递归转换所有子目录
python PVF格式转换工具.py ./equipment --recursive --backup
```

### 示例3：预览模式

```bash
# 查看将要进行的更改，不实际修改文件
python PVF格式转换工具.py 文件名.equ --dry-run

# 输出示例：
# 📄 文件: 402560159.equ
# 将要进行的更改:
#   - 第 3 行: 修复引号格式
#   - 第 4 行: 多个空格转换为TAB分隔
#   - 第 5 行: 空格缩进转换为TAB
```

## ⚠️ 注意事项

### 使用前准备

1. **备份重要文件**
   ```bash
   # 建议使用 --backup 选项
   python PVF格式转换工具.py 文件名.equ --backup
   ```

2. **先使用预览模式**
   ```bash
   # 查看将要进行的更改
   python PVF格式转换工具.py 文件名.equ --dry-run
   ```

### 支持的文件类型

- `.equ` 文件（装备文件）
- `.stk` 文件（消耗品文件）
- `.pvf` 文件（通用PVF文件）

### 编码处理

- 自动检测文件编码（UTF-8、GBK）
- 输出文件统一使用UTF-8编码
- 保持中文字符的正确显示

## 🔍 错误排查

### 常见问题

1. **文件无法读取**
   ```
   ❌ 无法读取文件 xxx.equ: 'gbk' codec can't decode byte
   ```
   - 解决方案：文件可能使用了特殊编码，请检查文件编码

2. **权限错误**
   ```
   ❌ 无法保存文件 xxx.equ: Permission denied
   ```
   - 解决方案：检查文件是否被其他程序占用，或以管理员身份运行

3. **Python环境问题**
   ```
   'python' 不是内部或外部命令
   ```
   - 解决方案：确保Python已安装并添加到环境变量

### 验证转换结果

转换完成后，建议使用格式检查工具验证：

```bash
# 使用PowerShell检查工具
.\Check-PVFFormat.ps1 -FilePath "转换后的文件.equ" -ShowDetails

# 使用Python检查工具
python PVF格式检查工具.py "转换后的文件.equ"
```

## 📚 相关文档

- [PVF文件格式规范](./PVF文件格式规范.md) - 详细的格式规范说明
- [格式检查工具](./PVF格式检查工具.py) - 格式验证工具
- [STK文件模板](../04-实用工具/STK文件模板.md) - 标准模板参考

## 🤝 技术支持

如果在使用过程中遇到问题：

1. 查看工具输出的错误信息
2. 使用 `--dry-run` 模式预览更改
3. 检查文件编码和权限
4. 参考相关文档和示例

---

**重要提醒**：PVF文件格式要求极其严格，任何格式错误都可能导致游戏无法正常加载。使用转换工具前请务必备份原文件！